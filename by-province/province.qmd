---
title: "Province Report"
params:
  province: "GP"
format:
  html:
    page-layout: full
    toc: true
    toc-depth: 3
    embed-resources: true
---

```{r}
#| label: setup
#| include: false
#| message: false
#| warning: false

suppressPackageStartupMessages({
  library(data.table)
  library(plotly)
  library(crosstalk)
  library(DT)
  library(lubridate)
  library(htmltools)
  library(dplyr)
})

# Source NMC category definitions
cat_path <- if (file.exists("R/nmc_categories.r")) "R/nmc_categories.r" else "../R/nmc_categories.r"
source(cat_path)

# ── Province lookup ──────────────────────────────────────────────────────────
province_names <- c(
  EC  = "Eastern Cape",  FS = "Free State",    GP  = "Gauteng",
  KZN = "KwaZulu-Natal", LP = "Limpopo",       MP  = "Mpumalanga",
  NC  = "Northern Cape",  NW = "North West",   WC  = "Western Cape"
)

prov_code <- params$province[1]
prov_name <- province_names[prov_code]

# ── Load processed data (robust path: works from project root or by-province/) ──
data_path <- if (file.exists("data/processed/agg_province.rds")) {
  "data/processed/agg_province.rds"
} else if (file.exists("../data/processed/agg_province.rds")) {
  "../data/processed/agg_province.rds"
} else {
  stop("Cannot find agg_province.rds — run R/prepare_dashboard_data.r first")
}
agg_prov <- readRDS(data_path)
setDT(agg_prov)
agg_prov <- agg_prov[!is.na(prov_) & prov_ != ""]
agg_prov[, date := as.Date(date)]

# Filter to this province & assign NMC categories
prov_dt <- agg_prov[prov_ == prov_code]
prov_dt <- assign_nmc_category(prov_dt)

latest_date <- max(prov_dt$date, na.rm = TRUE)

# ── Population ───────────────────────────────────────────────────────────────
pop_lookup <- data.table(
  prov_ = c("EC", "FS", "GP", "KZN", "LP", "MP", "NC", "NW", "WC"),
  pop   = c(6734001, 2928903, 16098571, 11538813, 5941439, 4743584,
            1303047, 4141774, 7187004)
)
prov_pop <- pop_lookup[prov_ == prov_code, pop]

# ── KPI metrics ──────────────────────────────────────────────────────────────
month_start <- floor_date(latest_date, "month")
prev_month  <- month_start - months(1)

current_month <- prov_dt[date >= month_start]
total_current <- sum(current_month$count, na.rm = TRUE)
total_prev    <- sum(prov_dt[date >= prev_month & date < month_start, count], na.rm = TRUE)
n_conditions  <- uniqueN(current_month$condition[current_month$count > 0])

pct_change <- ifelse(total_prev > 0,
                     round((total_current - total_prev) / total_prev * 100, 1),
                     NA_real_)
arrow <- ifelse(!is.na(pct_change) & pct_change >= 0, "\u2191", "\u2193")

top_condition <- current_month[, .(n = sum(count, na.rm = TRUE)),
                                by = condition][which.max(n), condition]

# ── Monthly summary by category ──────────────────────────────────────────────
prov_dt[, month := floor_date(date, "month")]
monthly <- prov_dt[, .(
  cases = sum(count, na.rm = TRUE)
), by = .(Month = month, Condition = condition, nmc_category)]
monthly[, incidence_100k := round(cases / prov_pop * 1e5, 2)]
monthly[, Category := nmc_category_short(nmc_category)]

# ── Weekly summary by category ───────────────────────────────────────────────
prov_dt[, week_start := floor_date(date, "week")]
weekly <- prov_dt[, .(
  cases = sum(count, na.rm = TRUE)
), by = .(Week = week_start, Condition = condition, nmc_category)]
weekly[, incidence_100k := round(cases / prov_pop * 1e5, 2)]
weekly[, Category := nmc_category_short(nmc_category)]

# ── Current month summary by category ────────────────────────────────────────
current_summary <- current_month[, .(
  cases = sum(count, na.rm = TRUE)
), by = .(Condition = condition, nmc_category)]
current_summary[, incidence_100k := round(cases / prov_pop * 1e5, 2)]
current_summary[, Category := nmc_category_short(nmc_category)]
setorder(current_summary, nmc_category, -cases)

# ── Category totals ──────────────────────────────────────────────────────────
cat_totals <- current_summary[nmc_category > 0, .(
  total_cases   = sum(cases),
  n_conditions  = .N,
  top_condition = Condition[which.max(cases)],
  top_cases     = max(cases)
), by = .(nmc_category)]
cat_totals[, Category := nmc_category_label(nmc_category)]
setorder(cat_totals, nmc_category)

# ── Annual summary for counts table ─────────────────────────────────────────
annual <- prov_dt[, .(
  Cases = sum(count, na.rm = TRUE)
), by = .(Year = year(date), Condition = condition, nmc_category)]
annual[, Category := nmc_category_short(nmc_category)]

annual_wide <- dcast(annual, Condition + Category ~ Year, value.var = "Cases", fill = 0)
year_cols <- setdiff(names(annual_wide), c("Condition", "Category"))
annual_wide[, Total := rowSums(.SD, na.rm = TRUE), .SDcols = year_cols]
setorder(annual_wide, -Total)

# ── Annual incidence table ───────────────────────────────────────────────────
annual_inci <- copy(annual)
annual_inci[, Incidence_100k := round(Cases / prov_pop * 1e5, 2)]
ici_wide <- dcast(annual_inci, Condition + Category ~ Year, value.var = "Incidence_100k", fill = 0)

# ── SharedData for linked filtering ──────────────────────────────────────────
sd_monthly <- SharedData$new(monthly)
```

```{r}
#| label: dynamic-title
#| results: asis
#| echo: false
cat(sprintf(
  '::: {.hero-intro}\n\n**%s (%s)** — Provincial surveillance by NMC category: immediate notification, routine, sentinel, and AMR.\n\n**Data through:** %s &nbsp;|&nbsp; **Population:** %s\n\n[Home](../../index.html){.btn .btn-sm .btn-primary style="margin-right:0.5rem;"} [All Provinces](../index.html){.btn .btn-sm .btn-outline-primary}\n\n:::\n',
  prov_name, prov_code,
  format(latest_date, "%d %B %Y"),
  format(prov_pop, big.mark = ",")
))
```

```{r}
#| label: kpi-cards
#| results: asis
#| echo: false
cat(sprintf(
'
::: {layout-ncol=4}

::: {.card .bg-primary .text-white .p-3 .text-center}
**Total Cases**

### %s
<span style="font-size:0.8rem;">%s</span>
:::

::: {.card .bg-info .text-white .p-3 .text-center}
**Month Change**

### %s %s%%%%
<span style="font-size:0.8rem;">vs previous month</span>
:::

::: {.card .bg-success .text-white .p-3 .text-center}
**Conditions**

### %s
<span style="font-size:0.8rem;">reporting this month</span>
:::

::: {.card .bg-warning .text-dark .p-3 .text-center}
**Top Condition**

### %s
<span style="font-size:0.8rem;">highest case count</span>
:::

:::
',
  format(total_current, big.mark = ","),
  format(month_start, "%%B %%Y"),
  arrow, abs(pct_change),
  n_conditions,
  top_condition
))
```

---

## Category Summary

```{r}
#| label: tbl-cat-summary
DT::datatable(
  cat_totals[, .(Category, `Total Cases` = total_cases,
                 `Conditions Reporting` = n_conditions,
                 `Top Condition` = top_condition,
                 `Top Cases` = top_cases)],
  rownames = FALSE,
  options = list(dom = "t", pageLength = 10, ordering = FALSE),
  caption = paste0("NMC category summary — ", prov_name, " (", format(month_start, "%B %Y"), ")")
)
```

---

## Category 1 — Immediate Notification {#cat1}

::: {.callout-important}
## Requires immediate public health action
Category 1 conditions must be notified within **24 hours**. Includes diseases of high epidemic potential (cholera, measles, malaria, meningococcal disease, VHFs). **Use this section for rapid situational awareness.**
:::

```{r}
#| label: cat1-data
#| include: false
cat1_weekly  <- weekly[nmc_category == 1]
cat1_monthly <- monthly[nmc_category == 1]
cat1_current <- current_summary[nmc_category == 1]
```

### Cases by Condition {.tabset}

#### Current Month

```{r}
#| label: fig-cat1-bar
if (nrow(cat1_current) > 0) {
  plot_ly(cat1_current[cases > 0], x = ~reorder(Condition, -cases), y = ~cases,
          type = "bar", marker = list(color = "#d9534f"),
          hoverinfo = "text",
          text = ~paste0(Condition, ": ", cases, " cases")) %>%
    layout(xaxis = list(title = "", tickangle = -45),
           yaxis = list(title = "Cases"), margin = list(b = 120))
} else {
  htmltools::p("No Category 1 conditions reported this month.", style = "color:gray;")
}
```

#### Weekly Epicurve

```{r}
#| label: fig-cat1-weekly
if (nrow(cat1_weekly) > 0) {
  plot_ly(cat1_weekly, x = ~Week, y = ~cases, color = ~Condition,
          type = "bar", hoverinfo = "text",
          text = ~paste0(Condition, "<br>Week: ", format(Week, "%d %b %Y"),
                         "<br>Cases: ", cases)) %>%
    layout(barmode = "stack",
           xaxis = list(title = "Week"), yaxis = list(title = "Weekly cases"),
           legend = list(orientation = "h", y = -0.2))
} else {
  htmltools::p("No Category 1 data available.", style = "color:gray;")
}
```

#### Monthly Trend

```{r}
#| label: fig-cat1-monthly
if (nrow(cat1_monthly) > 0) {
  plot_ly(cat1_monthly, x = ~Month, y = ~cases, color = ~Condition,
          type = "scatter", mode = "lines+markers", marker = list(size = 5),
          hoverinfo = "text",
          text = ~paste0(Condition, "<br>", format(Month, "%b %Y"),
                         "<br>Cases: ", cases)) %>%
    layout(xaxis = list(title = "Month"), yaxis = list(title = "Monthly cases"),
           legend = list(orientation = "h", y = -0.2))
} else {
  htmltools::p("No Category 1 data available.", style = "color:gray;")
}
```

#### Incidence Trend

```{r}
#| label: fig-cat1-incidence
if (nrow(cat1_monthly) > 0) {
  plot_ly(cat1_monthly, x = ~Month, y = ~incidence_100k, color = ~Condition,
          type = "scatter", mode = "lines+markers", marker = list(size = 5),
          hoverinfo = "text",
          text = ~paste0(Condition, "<br>", format(Month, "%b %Y"),
                         "<br>Inc: ", incidence_100k, " /100k")) %>%
    layout(xaxis = list(title = "Month"), yaxis = list(title = "Incidence per 100 000"),
           legend = list(orientation = "h", y = -0.2))
} else {
  htmltools::p("No Category 1 incidence data.", style = "color:gray;")
}
```

### Data Table

```{r}
#| label: tbl-cat1
if (nrow(cat1_current) > 0) {
  DT::datatable(cat1_current[, .(Condition, Cases = cases, `Incidence /100k` = incidence_100k)],
    extensions = "Buttons", rownames = FALSE,
    options = list(dom = "Bfrtip", buttons = c("csv", "excel"),
                   pageLength = 30, order = list(list(1, "desc"))))
} else {
  htmltools::p("No Category 1 data to display.", style = "color:gray;")
}
```

---

## Category 2 — Routine Notification (Trend Monitoring) {#cat2}

::: {.callout-note}
## Higher-volume conditions for quarterly trend reports
Category 2 conditions are notified within **7 days**. Includes TB (all forms), hepatitis A–E, schistosomiasis (bilharzia), congenital syphilis, poisonings, and maternal deaths. **Use this section for routine monitoring and quarterly reporting.**
:::

```{r}
#| label: cat2-data
#| include: false
cat2_weekly  <- weekly[nmc_category == 2]
cat2_monthly <- monthly[nmc_category == 2]
cat2_current <- current_summary[nmc_category == 2]
```

### Cases by Condition {.tabset}

#### Current Month

```{r}
#| label: fig-cat2-bar
if (nrow(cat2_current) > 0) {
  plot_ly(cat2_current[cases > 0], x = ~reorder(Condition, -cases), y = ~cases,
          type = "bar", marker = list(color = "#5bc0de"),
          hoverinfo = "text",
          text = ~paste0(Condition, ": ", cases, " cases")) %>%
    layout(xaxis = list(title = "", tickangle = -45),
           yaxis = list(title = "Cases"), margin = list(b = 120))
} else {
  htmltools::p("No Category 2 conditions reported this month.", style = "color:gray;")
}
```

#### Weekly Epicurve

```{r}
#| label: fig-cat2-weekly
if (nrow(cat2_weekly) > 0) {
  plot_ly(cat2_weekly, x = ~Week, y = ~cases, color = ~Condition,
          type = "bar", hoverinfo = "text",
          text = ~paste0(Condition, "<br>Week: ", format(Week, "%d %b %Y"),
                         "<br>Cases: ", cases)) %>%
    layout(barmode = "stack",
           xaxis = list(title = "Week"), yaxis = list(title = "Weekly cases"),
           legend = list(orientation = "h", y = -0.2))
} else {
  htmltools::p("No Category 2 data available.", style = "color:gray;")
}
```

#### Monthly Trend

```{r}
#| label: fig-cat2-monthly
if (nrow(cat2_monthly) > 0) {
  plot_ly(cat2_monthly, x = ~Month, y = ~cases, color = ~Condition,
          type = "scatter", mode = "lines+markers", marker = list(size = 5),
          hoverinfo = "text",
          text = ~paste0(Condition, "<br>", format(Month, "%b %Y"),
                         "<br>Cases: ", cases)) %>%
    layout(xaxis = list(title = "Month"), yaxis = list(title = "Monthly cases"),
           legend = list(orientation = "h", y = -0.2))
} else {
  htmltools::p("No Category 2 data available.", style = "color:gray;")
}
```

#### Quarterly Summary

```{r}
#| label: fig-cat2-quarterly
if (nrow(cat2_monthly) > 0) {
  cat2_qtr <- cat2_monthly[, .(cases = sum(cases)),
                            by = .(Quarter = floor_date(Month, "quarter"), Condition)]
  plot_ly(cat2_qtr, x = ~Quarter, y = ~cases, color = ~Condition,
          type = "bar", hoverinfo = "text",
          text = ~paste0(Condition, "<br>Q", quarter(Quarter), " ",
                         year(Quarter), "<br>Cases: ", cases)) %>%
    layout(barmode = "stack",
           xaxis = list(title = "Quarter"), yaxis = list(title = "Quarterly cases"),
           legend = list(orientation = "h", y = -0.2))
} else {
  htmltools::p("No Category 2 quarterly data.", style = "color:gray;")
}
```

### Data Table

```{r}
#| label: tbl-cat2
if (nrow(cat2_current) > 0) {
  DT::datatable(cat2_current[, .(Condition, Cases = cases, `Incidence /100k` = incidence_100k)],
    extensions = "Buttons", rownames = FALSE,
    options = list(dom = "Bfrtip", buttons = c("csv", "excel"),
                   pageLength = 30, order = list(list(1, "desc"))))
} else {
  htmltools::p("No Category 2 data to display.", style = "color:gray;")
}
```

---

## Category 3 — Sentinel Surveillance {#cat3}

::: {.callout-tip collapse="true"}
## Sentinel site monitoring
Category 3 covers arboviral diseases (Chikungunya, Sindbis, West Nile, Zika, Dengue), non-typhoidal Salmonellosis, STEC, Shigellosis, and resistant Gonorrhoea.
:::

```{r}
#| label: cat3-data
#| include: false
cat3_weekly  <- weekly[nmc_category == 3]
cat3_monthly <- monthly[nmc_category == 3]
cat3_current <- current_summary[nmc_category == 3]
```

### Cases by Condition {.tabset}

#### Current Month

```{r}
#| label: fig-cat3-bar
if (nrow(cat3_current) > 0) {
  plot_ly(cat3_current[cases > 0], x = ~reorder(Condition, -cases), y = ~cases,
          type = "bar", marker = list(color = "#5cb85c"),
          hoverinfo = "text",
          text = ~paste0(Condition, ": ", cases, " cases")) %>%
    layout(xaxis = list(title = "", tickangle = -45),
           yaxis = list(title = "Cases"), margin = list(b = 120))
} else {
  htmltools::p("No Category 3 conditions reported this month.", style = "color:gray;")
}
```

#### Monthly Trend

```{r}
#| label: fig-cat3-monthly
if (nrow(cat3_monthly) > 0) {
  plot_ly(cat3_monthly, x = ~Month, y = ~cases, color = ~Condition,
          type = "scatter", mode = "lines+markers", marker = list(size = 5),
          hoverinfo = "text",
          text = ~paste0(Condition, "<br>", format(Month, "%b %Y"),
                         "<br>Cases: ", cases)) %>%
    layout(xaxis = list(title = "Month"), yaxis = list(title = "Monthly cases"),
           legend = list(orientation = "h", y = -0.2))
} else {
  htmltools::p("No Category 3 trend data.", style = "color:gray;")
}
```

### Data Table

```{r}
#| label: tbl-cat3
if (nrow(cat3_current) > 0) {
  DT::datatable(cat3_current[, .(Condition, Cases = cases, `Incidence /100k` = incidence_100k)],
    extensions = "Buttons", rownames = FALSE,
    options = list(dom = "Bfrtip", buttons = c("csv", "excel"), pageLength = 20))
} else {
  htmltools::p("No Category 3 data to display.", style = "color:gray;")
}
```

---

## Category 4 — AMR Organisms {#cat4}

::: {.callout-warning collapse="true"}
## Antimicrobial resistance monitoring
Category 4 covers CPE, VRE, GISA/hGISA, colistin-resistant *Pseudomonas*/*Acinetobacter*, and *C. difficile*.
:::

```{r}
#| label: cat4-data
#| include: false
cat4_weekly  <- weekly[nmc_category == 4]
cat4_monthly <- monthly[nmc_category == 4]
cat4_current <- current_summary[nmc_category == 4]
```

### Cases by Condition {.tabset}

#### Current Month

```{r}
#| label: fig-cat4-bar
if (nrow(cat4_current) > 0) {
  plot_ly(cat4_current[cases > 0], x = ~reorder(Condition, -cases), y = ~cases,
          type = "bar", marker = list(color = "#f0ad4e"),
          hoverinfo = "text",
          text = ~paste0(Condition, ": ", cases, " cases")) %>%
    layout(xaxis = list(title = "", tickangle = -45),
           yaxis = list(title = "Cases"), margin = list(b = 120))
} else {
  htmltools::p("No Category 4 conditions reported this month.", style = "color:gray;")
}
```

#### Monthly Trend

```{r}
#| label: fig-cat4-monthly
if (nrow(cat4_monthly) > 0) {
  plot_ly(cat4_monthly, x = ~Month, y = ~cases, color = ~Condition,
          type = "scatter", mode = "lines+markers", marker = list(size = 5),
          hoverinfo = "text",
          text = ~paste0(Condition, "<br>", format(Month, "%b %Y"),
                         "<br>Cases: ", cases)) %>%
    layout(xaxis = list(title = "Month"), yaxis = list(title = "Monthly cases"),
           legend = list(orientation = "h", y = -0.2))
} else {
  htmltools::p("No Category 4 trend data.", style = "color:gray;")
}
```

### Data Table

```{r}
#| label: tbl-cat4
if (nrow(cat4_current) > 0) {
  DT::datatable(cat4_current[, .(Condition, Cases = cases, `Incidence /100k` = incidence_100k)],
    extensions = "Buttons", rownames = FALSE,
    options = list(dom = "Bfrtip", buttons = c("csv", "excel"), pageLength = 20))
} else {
  htmltools::p("No Category 4 data to display.", style = "color:gray;")
}
```

---

## All Conditions — Full Tables {.tabset}

### Annual Counts

```{r}
#| label: tbl-annual-counts
DT::datatable(
  annual_wide,
  caption = paste0("Annual notification counts by NMC category — ", prov_name),
  extensions = "Buttons",
  filter   = "top",
  rownames = FALSE,
  options  = list(
    dom        = "Bfrtip",
    buttons    = c("csv", "excel", "pdf"),
    pageLength = 25,
    scrollX    = TRUE,
    order      = list(list(ncol(annual_wide) - 1, "desc"))
  )
)
```

### Annual Incidence

```{r}
#| label: tbl-annual-incidence
DT::datatable(
  ici_wide,
  caption = paste0("Annual incidence per 100 000 — ", prov_name,
                   " (pop: ", format(prov_pop, big.mark = ","), ")"),
  extensions = "Buttons",
  filter   = "top",
  rownames = FALSE,
  options  = list(
    dom        = "Bfrtip",
    buttons    = c("csv", "excel", "pdf"),
    pageLength = 25,
    scrollX    = TRUE
  )
)
```

### Monthly Detail

```{r}
#| label: tbl-monthly-detail
DT::datatable(
  sd_monthly,
  caption = paste0("Monthly data — ", prov_name, " (linked to filter)"),
  extensions = "Buttons",
  filter   = "top",
  rownames = FALSE,
  options  = list(
    dom        = "Bfrtip",
    buttons    = c("csv", "excel"),
    pageLength = 20,
    scrollX    = TRUE
  )
)
```

---

## Province Navigation

::: {.prov-nav-grid}
[Eastern Cape](../ec/index.html){.btn .btn-outline-primary .btn-sm}
[Free State](../fs/index.html){.btn .btn-outline-primary .btn-sm}
[Gauteng](../gp/index.html){.btn .btn-outline-primary .btn-sm}
[KwaZulu-Natal](../kzn/index.html){.btn .btn-outline-primary .btn-sm}
[Limpopo](../lp/index.html){.btn .btn-outline-primary .btn-sm}
[Mpumalanga](../mp/index.html){.btn .btn-outline-primary .btn-sm}
[Northern Cape](../nc/index.html){.btn .btn-outline-primary .btn-sm}
[North West](../nw/index.html){.btn .btn-outline-primary .btn-sm}
[Western Cape](../wc/index.html){.btn .btn-outline-primary .btn-sm}
:::

---

::: {.callout-tip}
## Related Sections
- [By Province — Overview](../index.html) — cross-province comparison by NMC category
- [By Condition](../../by-condition/index.html) — condition-first view with national trends
- [Trending & Signals](../../by-trending/index.html) — signal detection for emerging conditions
- [Burden of Disease](../../burden-of-disease/index.html) — YLL, DALYs & age-standardised rates
- [Forecasts](../../by-forecasts/index.html) — short-term predictive models
- [Explorer](../../explorer/index.html) — national data explorer by NMC category
- [Data Quality](../../quality.html) — reporting completeness underpinning this data
:::


