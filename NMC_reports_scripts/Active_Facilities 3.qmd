---
title: "Number of active facilities"
format: html
format: 
#    docx: default
    html:
        embed-resources: true
        theme: cosmo
        scrolling: true
dpi: 300
fig-dpi: 300
execute:
  echo: false          # Show code output, but not code itself by default
  warning: false       # Suppress warnings
  message: false       # Suppress messages
  error: false         # Suppress errors in output (optional, if you want to prevent error messages)
---

# Methods
## Method 1 
Denominator: total number of facilities ever reported on NMC since 2019. 
Numerator 1 : Number of facilities ever reported in that province and year. 

## Method 2 
Denominator: The  Master Facility List (MFL) excluding no main facilites such as schools and satellite clinics.    
Numerator 1 :We wil then see the number of facilities that have made 1 notification for category 1  condition between 2022 and 2024. 
Numerator 2: The number of facilities that have made any notification aside from a COVID-19 notification between 2022 and 2024. 

```{r, setup }
#| include: false
#| echo: false 

flextable::set_flextable_defaults(font_size = 8,
padding.top = 0, padding.bottomg = 0, 
padding.left = 0, padding.right = 0)

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width=12, fig.height=6, dpi = 150, fig.align = "center", fig.cap = TRUE)

pacman::p_load(tidyverse, janitor, readr, readxl, janitor, tabyl)
#load MFL 
directory_files<- list.files()
mfl_path<- directory_files[grepl("MFL",directory_files)]
mfl <-read_csv( mfl_path)%>%clean_names

#mfl$types %>%tabyl()%>%arrange(-n)
# get a table of MFL facilities 
?tbl_summary
mfl%>%glimpse
mfl%>%
mutate( types = trimws(gsub( "WC|COVID-19", "", types)))%>%
select( types) %>%
tbl_summary(
    sort = all_categorical(FALSE) ~ "frequency",
)%>%
as_flex_table()#%>%save_as_docx( path = "MFL_facilities.docx")

```

# Result Method 1 
```{r}
#| echo: false 


load("~/Desktop/SAFETP/CLA/NMC_database/master/new_master.rda")

  # Plan 
  #| 1. database of facilities that made notifications during COVID
  #| 2. Some sort of timescale (months) of those facilties who have made any notification since then 
  #| 3. Focus on hospitals first. 

library(NMCleaner)
pacman::p_load(tidyverse, dplyr, janitor, magrittr)
conflicted::conflicts_prefer(dplyr::filter)

new_master<- new_master %>%mutate_dates(., date_index = "notification_date")

#new_master$facility_sector %>%tabyl()
#new_master$facility_sector %>%tabyl()
new_master$facility_type %>%tabyl()%>%arrange(-n)%>% select(1) %>%pull()->common_facility_types

new_master%>%
filter( !is.na(prov_),
!condition %in% "Covid-19")%>%
mutate( facility_sector = if_else(grepl("^pr", ignore.case = TRUE, facility_sector), "Private" , "Public"),
            facility_type = if_else( !facility_type %in%c(common_facility_types[1:5]), "Other",  facility_type )
            ) %>%
            mutate(facility_type = if_else( facility_type == "PRIVATE PRACTICE", "CLINIC", facility_type)) ->df


#df$facility_type %>%tabyl()%>%arrange(-n)

#df %>%filter( facility_type %in% c("DEPOT"))%>%view()
#new_master%>%filter(facility_type %in% c("DEPOT"))%>%view()


new_master%>%
filter( !is.na(prov_))%>%
mutate( facility_sector = if_else(grepl("^pr", ignore.case = TRUE, facility_sector), "Private" , "Public"),
            facility_type = if_else( !facility_type %in%c(common_facility_types[1:5]), "Other",  facility_type )
            ) %>%
            mutate(facility_type = if_else( facility_type == "PRIVATE PRACTICE", "CLINIC", facility_type)) %>%
select( facility, facility_sector, facility_type, prov_)%>%
distinct(facility, .keep_all = TRUE) -> all_NMC_facilities 


```


```{r}
#| echo: false 
#| label: tbl-NumberOfFacilitiesSectorType
#| tbl-cap: The number of unique facilities that have ever reported to NMC between 2019-2024


all_NMC_facilities%>%
select( -facility)%>%
tbl_strata( 
    strata = facility_type, 
    .tbl_fun = ~ .x %>%
    tbl_summary( 
    by = facility_sector, 
    percent = "row", 
    statistic = list( prov_ ~ "{n}\n({p}%)"),
    label = list( prov_ ~ "Province"))
)%>%as_flex_table()%>%autofit()

```

# The number of notifications from these facilities
```{r}
#| echo: false 
#| label: tbl-NumberOfNotificationsSectorType
#| tbl-cap: The number of category 1 notifications that have ever reported to NMC by facility type. * Column percentages are shown for provinces, Row percentages shown for total.

df%>%
filter( 
    #year %in% 2024, 
    nmccategories %in% 1, 
    ) %>%
select(  facility_sector, facility_type, prov_ )%>%
#mutate( Total = TRUE)%>%
#distinct( ., keep_all= TRUE) %>%
tbl_strata( 
    strata = facility_type, 
    .tbl_fun = ~ .x %>%
    tbl_summary( by = facility_sector, 
    percent = "column", 
    statistic = list( prov_ ~ "{n}\n({p}%)"),
    label =list( prov_ ~ "Province"))
)-> provinces_tbl 


df%>%
filter( 
    #year %in% 2024, 
    nmccategories %in% 1 
    ) %>%
select(  facility_sector, facility_type, prov_ )%>%
mutate( Total = TRUE)%>%
select( facility_type, facility_sector, Total)%>%
#distinct( ., keep_all= TRUE) %>%
tbl_strata( 
    strata = facility_type, 
    .tbl_fun = ~ .x %>%
    tbl_summary( by = facility_sector, 
    percent = "row", 
    statistic = list( Total ~ "{n}"),
    #label =list( prov_ ~ "Province")
    )
)-> total_tbl 



df%>%filter( nmccategories ==1) %>%nrow() -> total_cat1

total_tbl%>%modify_table_body( ~ .x %>%
    dplyr::mutate( across(contains("stat"), ~ paste0( .x, " (", 
    scales::percent(round(as.numeric(gsub(",", "",.x))/total_cat1, 2)), 
    
    ")")))
    ) -> total_tbl
    
tbl_stack( tbls = list( provinces_tbl, total_tbl))  %>%as_flex_table()%>%autofit()



```

# Active facilities post COVID-19 

```{r}
#| echo: false 
#| label: fig-Proportion_reportingFacilities
#| fig-cap: The proportion of facilities per province that made notificaitons per year out of the toal number of unique facilities that ever made a notifiation to NMC between 2019-2024.

df%>%
    filter( year %in% 2024, 

    #nmccategories %in% 1 
            ) %>%
        select( facility, facility_sector, facility_type, prov_ )%>%
        distinct()%>%
        mutate( year2024 = TRUE) ->facilities_2024



2019:2024 %>%
map( ~ {
    df%>%
        filter( year %in% .x,)%>%
        select( facility, facility_sector, facility_type, prov_ )%>%
        distinct()%>%
        mutate( !! sym( paste0("year", .x)) := TRUE) 
            }
    )%>%
    reduce( full_join, by = c("facility", "facility_sector", "facility_type", "prov_")) ->facilities_2024

# level it by the 2024  so that the legend andthe final line are otgether
facilities_2024%>%group_by(prov_, year2024) %>%
summarise( n = n()) %>%
group_by( prov_)%>%
mutate( prop = round(n/sum(n),2))%>%
filter( year2024 == TRUE)%>%
select(prov_) %>%pull() -> prov_labels 

facilities_2024%>%
    pivot_longer( cols = starts_with("year"), names_to = "year", values_to = "active")%>%
    group_by(year , active, prov_ ) %>% 
    summarise( n = n() ) %>%
    mutate( year = as.numeric(gsub("year", "", year)))%>%
    group_by(prov_, year ) %>%
    mutate( prop = (round(n/sum(n),2)),
    prov_ = factor(prov_ ,levels = c(prov_labels)))%>%
    filter( active == TRUE)%>%
    ungroup()-> year_on_year_prov_

    year_on_year_prov_%>%
    group_by(year) %>%
    summarise( n = sum(n))%>%
    mutate( prop = (n /nrow(facilities_2024)))%>%
    ungroup()%>%
    mutate( 
        prov_ = "All", 
        active = TRUE) %>%
        bind_rows(year_on_year_prov_) -> year_on_year_prov_
    



ggplot()+
    geom_line( 
        data = year_on_year_prov_%>%
        filter( !prov_ %in% "All") ,
        aes(x = year, y = prop, color = prov_),
         size = 3)+
    
    #geom_text(data = year_on_year_prov_%>%
    #    filter( !prov_ %in% "All") ,
    #    aes(x = year, y = prop, label = scales::percent(prop)), vjust = -0.5)+
    scale_color_brewer(palette = "Paired")+
    geom_line(
        data = year_on_year_prov_%>%
        filter( prov_ %in% "All") ,
        aes(x = year, y = prop),
         size = 4,
         linetype = "dashed", 
         #legend = TRUE
         )+
    labs( title = "Proportion of active facilities", x = "Year", y = "Proportion")+
    scale_y_continuous(labels = scales::percent, breaks = seq(0,1,0.05))+
    theme_minimal()+
    theme(legend.position = "right",
                panel.grid.minor.x = element_blank(),
                panel.grid.minor.y = element_blank())


```

# Table of proportion of total facilitis notifying in a year. 
```{r}
#| echo: false 
#| label: tbl-PropFacilities
#| tbl-cap: The proportion of facilities per province that made notificaitons per year out of the toal number of unique facilities that ever made a notifiation to NMC between 2019-2024.

# make a custom table with the number of facilities taht are active each year, the percentage should be the porportion of total facilities in that province. 

# make one without percent first 
c(prov_labels, "All") %>%
    map( ~
        year_on_year_prov_%>%
            filter( prov_ %in% .x )%>%
            select( prop, year)%>%
            tbl_summary( 
                by = year, 
                type = list(prop ~ "continuous"),
                statistic = list(prop ~ "{mean}"),
                label = list( prop= .x)
            )%>%
            modify_header(all_stat_cols() ~ "**{level}**") %>%
            modify_footnote( everything()  ~ NA)
            )%>%
    tbl_stack() -> per_tbl



per_tbl%>%
            modify_table_body(
                ~ .x %>%
                dplyr::mutate( across(contains("stat"), as.numeric) )%>%
                dplyr::mutate( across(contains("stat"), scales::percent) )
            )%>%as_flex_table()%>%autofit()

```


```{r}
#| echo: false 
#| label: tbl-NumFacilities
#| tbl-cap: The number of unique facilities that have ever reported to NMC between 2019-2024


c(prov_labels, "All") %>%
    map( ~
        year_on_year_prov_%>%
            filter( prov_ %in% .x )%>%
            select( n, year)%>%
            tbl_summary( 
                by = year, 
                type = list(n ~ "continuous"),
                statistic = list(n ~ "{mean}"),
                label = list( n= .x)
            )%>%
            modify_header(all_stat_cols() ~ "**{level}**") %>%
            modify_footnote( everything()  ~ NA)
    )%>%
    tbl_stack()%>%as_flex_table()%>%autofit()

```


# Discussion
The proportion of facilities to ever report in a year was varied among provinces prior to COVID-19. The proportion of facilities reporting out of the total numebr of facilities ever to report, peaked in 2022 and has slowly declined uniformly across provinces. WC displays the lowest proportion of facilities reporting at 45% in 2024. 

The NMC received the most notificaiotns from Public Hospitals (34%), Private hospitals

```{r}
# can we come up with a ratio or number of the average number of notificatiosn each facility amkes? 
```