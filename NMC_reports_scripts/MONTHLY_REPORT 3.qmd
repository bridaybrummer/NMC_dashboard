---
title: "NOTIFIABLE MEDICAL CONDITIONS SURVEILLANCE SYSTEM"
author: "The National Institute for Communicable Diseases"
date: today
format:
    html: default
    docx:
        reference-doc: extras/weekly_IDSR_V2_template.docx
        reference-location: "section"
        number-sections: true
        fig-caption: true
        toc: true
        toc-depth: 3
execute:
  echo: false
  warning: false
  message: false
  error: false
params:
  reporting_month: "2025-05-01"
---



```{r}
#| include: false

# Some installation notes
# If on MacOS you will need to install brew @ https://brew.sh/
## you will need to install "Xquarts" if you are running on MacOS A https://www.xquartz.org/
# "brew install pandoc"

## You will also need to install pandoc from the system terminal https://pandoc.org/installing.html

# Install pacman if not already installed
if (!requireNamespace("pacman", quietly = TRUE)) {
    install.packages("pacman")
}

# Load pacman


library(NMCleaner)
conflicts_prefer(dplyr::filter)
library(stringdist)


# make a function for the gtsummary and flextable settings.
# rm(list = ls())
# gc()

flextable::set_flextable_defaults(
    font.family = "Century Gothic",
    font.size = 8,
    header.font.size = 8,
    border.color = "black",
    padding = 0.1
)


gtsummary::theme_gtsummary_language(language = "en", big.mark = " ", decimal.mark = ".")


knitr::opts_chunk$set(
    ft.align = "left",
    echo = FALSE, warning = FALSE, message = FALSE, out.width = "100%"
)

trim_tbl <- function(gt_summary_object) {
    length_table_body <- gt_summary_object$table_body %>% nrow()
    gt_summary_object$table_body <- gt_summary_object$table_body[2:length_table_body, ]
    return(gt_summary_object)
}


# Make the provincial specific datasets.
# load("~/Desktop/SAFETP/CLA/NMC_database/master/new_master.rda")
new_master <- arrow::read_feather("~/Desktop/SAFETP/CLA/NMC_database/master/new_master.feather")

new_master %>% mutate(
    nmccategories = if_else(condition %in% "Agricultural or stock remedy poisoning", "1", nmccategories)
) -> new_master


# the date that the data is up to date for
exported_date <- new_master$export_date %>%
    as_date() %>%
    max()
new_master$export_date %>%
    as_date() %>%
    unique()

load("reporting_month.rda")
reporting_date <- as_date("2024-11-01")
# the specific month of interest for the report
reporting_date <- reporting_month %>% as_date()

last_dat_reporting_month <- ceiling_date(as_date(reporting_date), "month") - days(1)


reporting_date_month_year <- format( # this is to say that the date the data is from is one day before the report was
    as.Date(as_date(reporting_date), format = "%d%B%Y") - days(0),
    "%B, %Y"
)


reporting_date_month <- format( # this is to say that the date the data is from is one day before the report was
    as.Date(as_date(reporting_date), format = "%d%B%Y") - days(0),
    "%B"
)



as_excel <- function() {
    theme_minimal() +
        theme(
            text = element_text(family = "Century Gothic", size = 10, color = "#333333"),
            panel.background = element_rect(fill = "#F8F8F8"),
            plot.background = element_rect(fill = "#F8F8F8"),
            panel.grid = element_line(color = "#DDDDDD"),
            legend.text = element_text(color = "#333333", size = 8),
            legend.title = element_text(color = "#333333", size = 10),
            plot.title = element_text(size = 10, color = "#666666"),
            plot.subtitle = element_text(size = 8, color = "#666666"),
            plot.caption = element_text(size = 8, color = "#666666"),
            legend.position = "right",
            legend.direction = "vertical",
            legend.key = element_blank(),
            legend.title.align = 0.5,
            axis.text.x = element_text(angle = 30),
            axis.title = element_text(size = 10, color = "#666666"),
            panel.grid.minor.x = element_blank(),
            panel.grid.minor.y = element_blank(),
            axis.ticks = element_line(size = 0.15, color = "grey20"),
            legend.background = element_rect(fill = "#F8F8F8", size = 0.25, linetype = "solid", colour = "grey50")
        )
}

# gtsummary table sshould end with 
# as_flex_table()%>%
# flextable::set_table_properties(layout = "autofit", width = 1)

```

```{r}
#| include: false 
# load up the excels
#load("~/Desktop/SAFETP/CLA/NMC_database/master/new_master.rda")


new_master <- new_master %>%
  mutate(across(c(nmccategories, case_type), as.factor))%>%
  filter( 
    #!case_type %in% "Laboratory notifications"
    )-> 
new_master

new_master%>%
  dplyr::filter( notification_date <as_date( last_dat_reporting_month))->
  new_master1 

reporting_yearmonth_grates<- last_dat_reporting_month%>%grates::as_yearmonth()

# report specifci cleaning. 
df<- new_master1%>%
  dplyr::filter( Month_notification %in% reporting_yearmonth_grates)%>%
  mutate( 'reporting' = 1)%>%
  dplyr::filter(!condition %in% "Leprosy")%>% # this is to exclude leprosy back capturing.
  dplyr::filter(!case_id %in% c("231005_4441991"))%>%
  dplyr::filter(! case_id %in% c("240126_46621391"))%>%
  mutate(condition = ifelse( condition =="Covid-19", "COVID-19", condition))%>%
  dplyr::filter( !is.na(prov_), 
          !condition %in% c("COVID-19", "Waterborne illness outbreak - undefined"))%>%
  ungroup()

df1<- df%>%dplyr::filter(back_capture_new %in% c("Current", "Delayed", "unknown"))
df2<- df%>%dplyr::filter( !back_capture_new %in% c("Current", "Delayed", "unknown"))


tabyl(Month_notification, dat = new_master%>%dplyr::filter(condition %in% "Covid-19"))

flextable::set_flextable_defaults(
    font.family = "Century Gothic",
    font.size = 6,
    header.font.size = 6,
    border.color = "black",
    padding = 0.1
)




source("scripts_and_functions/context_table.R")

```


```{r}
#| include: false

library(kableExtra)
# Replace the URL with your desired hyperlink
url <- "https://www.nicd.ac.za/wp-content/uploads/2022/09/NMCSS-Data-Interpretation-Infographic-final2.pdf"

# Create a clickable hyperlink
link_text <- paste0("[NMCSS Interpretation](", url, ")")

# Display the hyperlink using kableExtra
#kable(data.frame(Download_Link = link_text), escape = FALSE) %>%
#  kable_styling()
surveillance_url <- "https://www.nicd.ac.za/nmc-overview/nmc-monthly-surveillance-report/"
```

\newpage 

# Introduction {.unnumbered}
Data used in this report was drawn from the NMC-SS on **`r format(exported_date, "%d %B %Y") `**. The most recent report should always be viewed and can be found at [NMCSS surveillance reports](`r surveillance_url`)

The purpose of this report is to describe the number of notifications received by the Notifiable Medical Conditions Surveillance System (NMCSS). The report is publicly available and can be used by health professionals, researchers, the general public, or any other stakeholder. The purpose of disseminating this information is to inform any public health action - NMCSS data has limitations (see [NMCSS interpretation](`r url`).), but serves as a public health signal that may warrant further investigation. 

This report also monitors some surveillance system attributes. Including average notifications by facilities, data quality and timeliness of clinical diagnosis and notifications over time. (**see Appendix nos. 1 and 3**).

While this information is also publicly available, we aim this section of the report at those involved in notifying. These include Infection Prevention Control practitioners at facilities, Nurses, Doctors, pathologists and laboratory staff.

Category 4 NMCs, COVID-19, and multi-system inflammatory syndrome (MIS-C) have been excluded from this report. Where weeks are presented, the epiweek according to the CDC epiweeks are used.


## Highlights {.unnumbered}
```{r, include = FALSE}

# script for the tables you make that will be referenced in the in line chunks

tbl_notifications<- df1%>%select(nmccategories, time_to_notification) %>%
  mutate(time_to_notification = as.numeric(time_to_notification) )%>%
  tbl_summary(by= nmccategories, 
            label = list(time_to_notification ~ "Time to Notification"),
            digits = list(everything() ~ c(0,0))
            )%>%
  modify_footnote(update = everything() ~ NA)

cat1_notif_time<- tbl_notifications[["table_body"]][["stat_1"]][[1]]%>%as.character()

nmc_url <- "https://nmc.nicd.ac.za/Account/Login"
```
-   A total of `r format(nrow (df), big.mark = " ")` cases were notified in `r reporting_date_month_year` and most were category 2 conditions.
-   Category 1 cases were reported in median (IQR) of `r cat1_notif_time` days.
-  The most common conditions notified were `r df1$condition %>% unique() %>% sort() %>% paste(collapse = ", ")`.
-  

```{r}
#| label: tbl-highlightsNotifications
#| tbl-cap: !expr 'paste0("Highlights of notifications reported to the NMC, in South Africa; January 2022-",  reporting_date_month_year)'

df1 %>%
    select(
        nmccategories, case_type
    ) %>%
    mutate(
        nmccategories = paste0("Category ", nmccategories)
    ) %>%
    tbl_summary(
        by = case_type,
        percent = "row",
        label = list(nmccategories ~ "NMC Category"),
    ) %>%
    modify_header(label = "") -> tbl_by_case_type



df1 %>%
    # filter( case_definition %in% "Confirmed") %>%
    select(
        nmccategories, case_definition
    ) %>%
    mutate(
        nmccategories = paste0("Category ", nmccategories)
    ) %>%
    tbl_summary(
        by = case_definition,
        percent = "row",
        statistic = list(all_categorical() ~ "{n}/{N} ({p}%)"),
        label = list(nmccategories ~ "NMC Category"),
    ) %>%
    gtsummary::modify_column_hide(
        stat_2
    ) %>%
    modify_footnote_header(
        columns = everything(),
        footnote =
            "n confirmed / N (proportion confirmed %) \n Confirmed cases are verified and confirmed by the relevant centre at the NICD and can be considered confirmed cases. Centres may not always be able to verify when there are a high volume of notifications and it i best to refer to specific situation reprts for the most complete and up to date information."
    ) -> tbl_of_confirmed

# tbl_of_confirmed


# Table of diagnosis method by lab
# df1$diagnosis_method %>% tabyl()

df1 %>%
    mutate(
        nmccategories = paste0("Category ", nmccategories),
        case_definition = if_else(grepl("lab|rapid", ignore.case = TRUE, diagnosis_method),
            "Confirmed", case_definition
        )
    ) %>%
    select(
        nmccategories, case_definition
    ) %>%
    tbl_summary(
        by = case_definition,
        percent = "row",
        label = list(nmccategories ~ "NMC Category"),
    ) %>%
    modify_header(label = "") %>%
    gtsummary::modify_column_hide(
        stat_2
    ) %>%
    modify_footnote_header(
        columns = everything(),
        footnote =
            "n confirmed / N (proportion confirmed %) \n Confirmed cases counted by the diganosis method reported by the  notifier. These include laboratory confirmed cases, rapid test confirmed cases. Not all of these are verified by the centre"
    ) -> tbl_by_diagnosis_method


tbl_merge(
    tbls = list(
        tbl_by_case_type,
        tbl_of_confirmed,
        tbl_by_diagnosis_method
    ),
    tab_spanner = c("**Case Type**", "**Confirmed by centre**", "**Reported by diagnosis method**")
) -> merged_table

tbl_of_confirmed%>%
as_flex_table() %>%
    theme_zebra() %>%
    # the top header row must be green with white font
    bg(, bg = "#A5CA64", part = "header") %>%
    flextable::color(, color = "white", part = "header") 

```

# Category 1 Conditions
Category 1 conditions must be notified within 24 hours of diagnosis by healthcare providers and private or public health laboratories. These
conditions must be notified based on clinical suspicion, before there is a laboratory confirmation. A total of `r format(nrow(df1%>%filter( nmccategories ==1)), big.mark = " ")` category 1 conditions were notified in `r reporting_date_month_year`. The majority of these notificaitons were notified with a median (IQR) time to notification of `r cat1_notif_time` days.... add moth specifics . 

## NMC Reporting application {.unnumbered}
-   [NMC Reporting App](`r nmc_url`). is available on both web and mobile platforms
-   Use recommended browsers in order to access NMC reporting App for notifications, searching of cases and reports.
-   Register if you have no NMC account and you can reset the password if you have not used the application over 12 months.

<br><br>

```{r}
#| width: 100%
#| fig.align: center

knitr::include_graphics("images/NOTE.png")
```

\newpage


## Current notification trends {.unnumbered}
Trends of notifications of selected conditions are presented below. Notifications that are confirmed are shown in table \@ref(tab:tab-epitable1). Confirmed notification are verified and confirmed by the relevant centre at the NICD and can be considered confirmed cases.
All notifications are shown after and include notifications that can be considered as suspected cases. These are presented to show the sensitivity of the surveillance system in recognising disease signals.


### Confirmed notifications {.unnumbered}

#### Epitable {.unnumbered}

```{r}
#| label: tbl-epitable1
#| tbl-cap: !expr 'paste0("Confirmed notifications of selected category 1 conditions reported to the NMC, in South Africa; January 2022-",  reporting_date_month_year)'

conflicts_prefer(dplyr::filter)



confirmed_new_master1 <- new_master1 %>%
    dplyr::filter(grepl("confirmed", ignore.case = TRUE, case_definition))

context_table(confirmed_new_master1, as_date(last_dat_reporting_month)) -> ft

df1 %>%
    group_by(epiweek, day) %>%
    summarise(n = n()) %>%
    group_by(epiweek) %>%
    summarise(row_number = row_number()) %>%
    filter(row_number == 7) %>%
    pull(epiweek) %>%
    as.numeric() %>%
    max() ->

max_full_epiweek

# used to be ``` grey_column <-  ft[[2]].....
grey_column <- max_full_epiweek - df1$notification_date %>%
    as_date() %>%
    max() %>%
    as_epiweek() %>%
    gsub(".*W", "", .) %>%
    as.numeric() + 4


ft[[1]]$col_keys %>% length() ->
col_length

ft[[1]]$body[[1]]$label%>%length() -> number_of_conditions


std_border <- officer::fp_border(color = "black", width = 1)


ft[[1]] %>%
    autofit() %>%
    fontsize(size = 7, part = "all") %>%
    bg(,
        j = (col_length - 5):col_length, # this will gry out the last 4 columns
        bg = "grey90",
        part = "body"
    ) %>%
    theme_zebra() %>%
    # the top header row must be green with white font
    bg(, bg = "#A5CA64", part = "header") %>%
    flextable::color(, color = "white", part = "header") %>%
    surround(
        j = c((col_length - 5)),
        # border = fp_border(color = "grey40", width = 2),
        part = "body",
        border.left = std_border,
    ) %>%
    surround(
        j = col_length,
        part = "body",
        border.right = std_border,
    ) %>%
    surround(
        i = c(1 ),
        j = c((col_length - 5):col_length),
        border.top = std_border,
    ) %>%
    surround(
        i = c(number_of_conditions ),
        j = c((col_length - 5):col_length),
        border.bottom = std_border,
    )



```

#### Trends Plot {.unnumbered}

```{r}
#| include: false
#| echo: false


# reset the formatting for hte rest of the RShowDoc()
flextable::set_flextable_defaults(
    font.family = "Century Gothic",
    font.size = 8,
    header.font.size = 8,
    border.color = "black",
    padding = 0.1
)


df_epicurve_confirmed <-
    new_master1 %>%
    dplyr::filter(case_definition %in% "Confirmed") %>%
    ungroup() %>%
    dplyr::filter(nmccategories == 1) %>%
    # dplyr::filter( condition =="COVID-19") %>%

    # dplyr::filter( notification_date < as_date("2024-01-01") )%>%
    epicurve_df(.,
        date_index = "notification_date",
        grouping_vars = "condition"
    )

current_year <- as.numeric(as_year(Sys.Date()))

df_epicurve_confirmed1 <- df_epicurve_confirmed %>%
    dplyr::filter(year %in% 2022:current_year) %>%
    mutate(year = factor(year, levels = c(2022:current_year)))

plot_confirmed <- df_epicurve_confirmed1 %>%
    dplyr::filter(condition %in% c(
        "Cholera",
        "Covid-19",
        "Diphtheria",
        "Malaria",
        "Measles",
        "Mpox",
        "Pertussis",
        "Rubella"
    )) %>%
    plot_epicurve_df(.,
        x_axis_option = "epiweek",
        grouping_vars = "condition",
        color_select = "olivedrab"
    )

# plot$plot
reporting_date_month_year

```



```{r}
#| label: fig-epicurve-confirmed
#| fig-cap: !expr 'paste0("Trend of weekly number of confirmed notifications for selected category 1 conditions reported to the NMC, in South Africa; January 2022-",  reporting_date_month_year)'
# |include: false
source("scripts_and_functions/gg2word.R")
gg2word(plot_confirmed$plot, "outputs", dims = c(11, 6.5))

```



## All Category 1 Conditions at a glance {.unnumbered}

```{r, evaluate = FALSE,  include = TRUE}
#| label: tbl-IDSR_snapshot
#| fig-cap: !expr 'paste0("The number of confirmed notifications (by diagnosis method) that are suspected and confirmed for category 1 conditions notified during ", format(reporting_date, "%B, %Y"))'


#| # make a table and some other quick descriptive of confirmed and suspected.
case_def_labs <- df1$case_definition %>% unique()

# df1 %>% tabyl(dat = ., condition , case_definition)
# source( "nmc_contacts_list.R")

category_1 <- condition_df %>%
    filter(nmccategories %in% 1) %>%
    select(condition) %>%
    pull() %>%
    sort()

cat_1 <- df1 %>%
    filter(nmccategories == 1) %>%
    select(condition) %>%
    unique() %>%
    pull()

# setdiff(cat_1, category_1)

df1 %>%
    filter(nmccategories == 1) %>%
    mutate(
        condition = factor(condition, levels = c(category_1)),
        case_definition = factor(if_else(grepl("lab|rapid", ignore.case = TRUE, diagnosis_method), "Confirmed", case_definition), levels = c("Suspected", "Confirmed"))
    ) %>%
    dplyr::select(condition, case_definition) %>%
    tbl_summary(
        by = case_definition,
        percent = "row",
        statistic = list(all_categorical() ~ "{n}/{N} ({p})%")
    ) %>%
    # add_overall(last = FALSE, statistic = ~"{n}") %>%
       modify_header( 
      stat_2 = "**Category 1**"
    )%>%
    #modify_header(
    #    label = "**Condition**",
    #    all_stat_cols() ~ "**{level}**, \n N = {scales::number(N)}"
    #) %>%
    trim_tbl() %>%
    modify_column_hide(
        stat_1
    )%>%
 
modify_footnote(update = everything() ~ NA) %>%
    modify_footnote(all_stat_cols() ~ "n confirmed/ N notified (proportion confirmed %) \n Confirmatiosn are taken from the centres input and clinicans reported diagnosis method") ->
cat_1_glance



ft <- cat_1_glance %>%
    as_flex_table() %>%
    fontsize(, size = 9, part = "header") %>%
    flextable::set_table_properties(layout = "autofit", width = 0.99)


to_bold <- which(!grepl("0\\/", ignore.case = TRUE, cat_1_glance$table_body$stat_2 ))

bold(ft, i = c(to_bold), j = 1) %>%
    bg(, i = c(to_bold), bg = "grey90", part = "body")%>%
    bg(, j = 1:2, bg = "#A5CA64", part = "header") %>%
    color( part = "header", color = "white") 


```


\newpage 

# NMC data summary, `r reporting_date_month_year` {.unnumbered}

```{r, include=FALSE}
#df$Back_capture%>%unique
back_captured<-nrow(df%>%filter(Back_capture %in% c("Delayed", "Back Captured")))

df1%>%
  ungroup()%>%
  select(case_type, nmccategories )%>%
  mutate( nmccategories = factor(nmccategories, levels = c(1,2,3)))%>%
tbl_summary(
                             by = case_type,
                             missing = "ifany",
                             label = list(nmccategories ~ ""),
            
                             )%>% 
  modify_header(all_stat_cols() ~ "**{level}**, \n n = {scales::number(n)}",
                label = "**NMC Category**") %>%
  add_overall()  %>%
  modify_footnote( update = everything() ~ NA)->
  table_summary


table_summary[["table_body"]][["label"]]<- c( "","Category 1", "Category 2",  "Category 3")
length<- table_summary[["table_body"]]%>%nrow()
table_summary[["table_body"]]<- table_summary[["table_body"]][2:length,]


cat1<-  table_summary[["table_body"]][["stat_0"]][grep("^category 1", table_summary[["table_body"]][["label"]], ignore.case = TRUE)]%>%as.character()

cat2<-  table_summary[["table_body"]][["stat_0"]][grep("^category 2", table_summary[["table_body"]][["label"]], ignore.case = TRUE)]%>%as.character()

cat3<-  table_summary[["table_body"]][["stat_0"]][grep("^category 3", table_summary[["table_body"]][["label"]], ignore.case = TRUE)]%>%as.character()

### Get into standard format for writing:

numbers <- gsub("\\D+", " ", cat2)
numbers <- strsplit(trimws(numbers), " ")[[1]]

# Format as "(n=7 906, 91%)"
output_text <- sprintf("(%s, %s%%)", paste(numbers[1], numbers[2]), numbers[3])

min_date<-format( min(as_date(df2$diagnosis_date), na.rm = T), "%B, %Y") 

back_captured<- df2%>%#filter( back_capture_new %in% c("Back capture", "Delayed"))%>%
  select( prov_, condition) %>%
  tbl_summary(by = prov_,
              statistic = all_categorical() ~ "{n}",
              label = condition ~ "",
                                 sort = list(everything() ~ "frequency"))%>%
    modify_header(all_stat_cols() ~ "**{level}**, \n ({scales::number(n)})",
                  label = "**Condition**"
  )%>%
  modify_footnote( update =  everything() ~ NA)

back_captured_overall<- df2%>%#filter( Back_capture %in% c("Back capture", "Delayed"))%>%
  select( condition) %>%
  tbl_summary(label = condition ~ "",
                                 sort = list(everything() ~ "frequency"))%>%
    modify_header(all_stat_cols() ~ "**{level}**, \n ({scales::number(n)})",
                  label = "**Condition**"
  )%>%
  modify_footnote( update =  everything() ~ NA)



tb_back_captured <-  back_captured_overall[["table_body"]][["stat_0"]][grep("^tuberculosis:p", back_captured_overall[["table_body"]][["label"]], ignore.case = TRUE)]%>%
  as.character()  %>%
  sub("* \\(", ", ",.)%>%
    sub("\\)", "",.)

most_common_back_captured_number<- back_captured_overall[["table_body"]][["stat_0"]][2] %>% as.character()  %>%
  sub("* \\(", ", ",.)%>%
    sub("\\)", "",.)
most_common_back_captured_condition<- back_captured_overall[["table_body"]][["label"]][2]

```


```{r}
#| include: false

prov_tbl<- df1 %>%select(prov_) %>% 
  tbl_summary(
    statistic = list(prov_ ~ "{n}, {p}%"),
    missing ="no"
  )


prov_tbl[["table_body"]] <- prov_tbl[["table_body"]] %>%
  mutate(
    n = as.numeric(gsub("[^0-9.]+", "", prov_tbl[["table_body"]][["stat_0"]])),
    n_percent = as.numeric(gsub("[^0-9.]+", "", gsub(".*\\((.*?)%\\).*", "\\1", prov_tbl[["table_body"]][["stat_0"]]))),
    n_text = gsub("[^a-zA-Z]+", "", gsub("n=[0-9.]+,\\s*\\((.*?)%\\)", "\\1", prov_tbl[["table_body"]][["stat_0"]])),
    na.rm = TRUE
  ) %>%
  arrange(-n)


prov_tbl[["table_body"]]
prov_tbl[["table_body"]][["label"]][1]

most_common_prov <- paste0(prov_tbl[["table_body"]][["label"]][1]," (",  prov_tbl[["table_body"]][["stat_0"]][1],")")
sec_common_prov <-  paste0(prov_tbl[["table_body"]][["label"]][2]," (",  prov_tbl[["table_body"]][["stat_0"]][2],")")
thir_common_prov <- paste0(prov_tbl[["table_body"]][["label"]][3]," (",  prov_tbl[["table_body"]][["stat_0"]][3],")")

length_tbl<- nrow(prov_tbl[["table_body"]])

least_common_prov <-     paste0(prov_tbl[["table_body"]][["label"]][length_tbl-1]," (",  prov_tbl[["table_body"]][["stat_0"]][length_tbl-1],")")

sec_least_common_prov <- paste0(prov_tbl[["table_body"]][["label"]][length_tbl-2]," (",  prov_tbl[["table_body"]][["stat_0"]][length_tbl-2],")")

intro_blurb <- paste0(
"A total of ", format(nrow(df), big.mark = " ")," current and delayed cases were notified to the NMCSS during ", reporting_date_month_year," **(See table 9 for further breaks downs and Appendix no.3 for definitions)**. There were ",format(nrow(df1), big.mark = " ")," current notifications; the majority ", output_text ," were category 2 conditions. The provinces with the highest number of notifications were ", most_common_prov, ", ", sec_common_prov, ", and ", thir_common_prov,". The provinces with the least number of notifications were ", least_common_prov,", and ", sec_least_common_prov,". There were ", nrow(df2), " back captured clinical notifications diagnosed between ", min_date, " and ", reporting_date_month_year," and only notified during ", reporting_date_month_year, ". The majority (", most_common_back_captured_number,") of those notifications were ",most_common_back_captured_condition,". (**See Appendix no.1**).")


#and n=", nrow(df2), " back captured notifications (**see Appendix no.3 for definitions**)
```

`r intro_blurb`

\vspace{3cm}


```{r, warnings = FALSE, message=FALSE, fig.cap ="", include = TRUE}

# this is the table that shwos the gender admission status and vital status by age catgery. 
# Something like this for each condition might be reallly useful 

df_tbl <- df1 


tbl0 <- df_tbl  %>%
  select(age_dob)%>%
  mutate( age_dob = as.numeric(age_dob))%>%
  tbl_summary(missing = "ifany",
                                                   label = list(age_dob~""),
                                                   statistic = all_categorical() ~ "{n}")  %>%
  modify_header(all_stat_cols() ~ "**{level}**")%>%
  modify_footnote(update = everything() ~ NA)

tbl0_total <- df_tbl %>%
  mutate(Total = TRUE)%>%
  select(Total)%>%
  tbl_summary(
              missing = "ifany", 
              #by = gender,
              statistic = all_categorical() ~ "{n}",
              #label = list(Total~"")
              )%>%
  modify_header(all_stat_cols() ~ "**{level}**")%>%
  modify_footnote(update = everything() ~ NA)


tbl_full_0 <- tbl_stack(tbls =list(tbl0, tbl0_total ))

# TABLE 1
tbl1 <- df_tbl %>%select(agecategory_unit, gender)%>%
  tbl_summary(
    missing = "ifany", 
    by = gender,
    statistic = all_categorical() ~ "{n}",
    label = list(agecategory_unit~""))%>%
  modify_header(all_stat_cols() ~ "**{level}**")%>%
  modify_footnote(update = everything() ~ NA)

tbl1_total <- df_tbl %>%select(gender)%>%
  mutate(Total = TRUE)%>%
  tbl_summary(missing = "ifany", 
              by = gender,
              statistic = all_categorical() ~ "{n}",
              #label = list(Total~"")
              )%>%
  modify_header(all_stat_cols() ~ "**{level}**")%>%
  modify_footnote(update = everything() ~ NA)


tbl_full_1 <- tbl_stack(tbls =list(tbl1, tbl1_total ))
# TABLE 2

tbl2 <- df_tbl %>%select(agecategory_unit, patient_admission_status)%>%
  tbl_summary(missing = "ifany", 
              by = patient_admission_status,
              statistic = all_categorical() ~ "{n}",
              label = list(agecategory_unit~""))%>%
  modify_header(all_stat_cols() ~ "**{level}**")  %>%
  modify_footnote(update = everything() ~ NA)


tbl2_total <- df_tbl %>%select(patient_admission_status)%>%
  mutate(Total = TRUE)%>%
  tbl_summary(missing = "ifany", 
              by = patient_admission_status,
              statistic = all_categorical() ~ "{n}",
              #label = list(Total~"")
              )%>%
  modify_header(all_stat_cols() ~ "**{level}**")%>%
  modify_footnote(update = everything() ~ NA)


tbl_full_2 <- tbl_stack(tbls =list(tbl2, tbl2_total ))

# TABLE 3
tbl3 <- df_tbl %>%select(agecategory_unit, patient_vital_status)%>%
  tbl_summary(missing = "ifany", 
              by = patient_vital_status,
              statistic = all_categorical() ~ "{n}",
              label = list(agecategory_unit~""))%>%
  modify_header(all_stat_cols() ~ "**{level}**")%>%
  modify_footnote(update = everything() ~ NA)

tbl3_total <- df_tbl %>%select(patient_vital_status)%>%
  mutate(Total = TRUE)%>%
  tbl_summary(missing = "ifany", 
              by = patient_vital_status,
              statistic = all_categorical() ~ "{n}",
              #label = list(Total~"")
              )%>%
  modify_header(all_stat_cols() ~ "**{level}**")%>%
  modify_footnote(update = everything() ~ NA)


tbl_full_3 <- tbl_stack(tbls =list(tbl3, tbl3_total ))

# Merged
tbl_merge <- tbl_merge(tbls = 
            list(tbl_full_1, tbl_full_2, tbl_full_3), 
          tab_spanner = c( "**Gender**", "**Admission Status**", "**Vital Status**"))%>%
  modify_header(label = "**Age Category**")

length<- tbl_merge[["table_body"]]%>%nrow()
tbl_merge[["table_body"]]<- tbl_merge[["table_body"]][2:length,]

tbl_merge%>%
  as_flex_table()%>%
  fontsize(, size = 9, part = "header")%>%
  flextable::set_table_properties(layout = "autofit", 
                                  width = 1)%>%
  flextable::set_caption("Age distribution by gender, admission status, and patient outcome") %>%
  bold(, j = 10)%>%
  bold(, i = length-1)%>%
  theme_zebra()%>%
  bg(., 
    part = "header", 
    bg  = "#A5CA64"
  )%>%
  flextable::color(, color = "white", part = "header")%>%
  # create inner vertical borders in a thin white line
  border_inner_v(
                  border = officer::fp_border(color = "white", width = 0.5), 
                  part = "all")

```



```{r blurbing}




          desc_tbl <- df1 %>% select(agecategory_unit, gender, patient_admission_status,patient_vital_status ) %>%tbl_summary

          #numbers <- desc_tbl[["table_body"]][["stat_0"]][2:15]
          
          numbers<- as.numeric(gsub( " ", "", gsub("\\(.*?\\)", "", desc_tbl[["table_body"]][["stat_0"]][2:15])), na.rm= T)
          
          male_perc<- desc_tbl[["table_body"]][["stat_0"]][grep(
            "^male", desc_tbl[["table_body"]][["label"]], ignore.case = TRUE)] %>%gsub(" \\(", ", ", .)
          
          female_perc<-  desc_tbl[["table_body"]][["stat_0"]][grep(
            "^female", desc_tbl[["table_body"]][["label"]], ignore.case = TRUE)]%>%gsub(" \\(", ", ", .)
          
          
          max_age_cat_n <-  desc_tbl[["table_body"]][["stat_0"]][grep(as.character(max(numbers, na.rm = T)), gsub( " ", "", gsub("\\(.*?\\)", "",desc_tbl[["table_body"]][["stat_0"]])))]%>%gsub(" \\(", ", ", .)
          
          max_age_name <- desc_tbl[["table_body"]][["label"]][grep(as.character(max(numbers, na.rm = T)), gsub( " ", "", gsub("\\(.*?\\)", "",desc_tbl[["table_body"]][["stat_0"]])))]%>%gsub(" \\(", ", ", .)
          
          n_hospitalised <- desc_tbl[["table_body"]][["stat_0"]][grep(
            "^inpatient", desc_tbl[["table_body"]][["label"]], ignore.case = TRUE)]%>%gsub(" \\(", ", ", .)%>%gsub("\\, ", " (", . )
    
          n_transferred <- desc_tbl[["table_body"]][["stat_0"]][grep(
            "^transferred", desc_tbl[["table_body"]][["label"]], ignore.case = TRUE)]%>%gsub(" \\(", ", ", .)%>%gsub("\\, ", " (", . )
    
          n_deaths <- desc_tbl[["table_body"]][["stat_0"]][grep(
            "^deceased", desc_tbl[["table_body"]][["label"]], ignore.case = TRUE)]

    if (male_perc > female_perc) {
      proportion <- male_perc
      gender <- "males"
      gender_single <- "male"
    } else {
      proportion <- female_perc
      gender <- "females"
      gender_single <- "female"
    }
    
blurb <- paste0("Most of the notified cases were ", gender ," (", male_perc, ". Individuals in the ",max_age_name," year age group represented the majority (", max_age_cat_n," of notified cases. At the time of notification, ", n_hospitalised, " of the notified cases were hospitalized, while ", n_transferred," were transferred to another healthcare facility. There were ", sub(" .*", "", n_deaths), " deaths notified during the reporting period.")

```

`r blurb`

\newpage


## Category 1 notifications {.unnumbered}

```{r , label = cat_suspected_blurb ,include = FALSE,  warnings = FALSE, message=FALSE, fig.cap = "" }


# set the category number 
  category_number <- 1

# Create the dataset for the category 
  tbl_df2 <- df1 %>%filter(nmccategories ==category_number) %>%setDT() 

# check any missing naming of conditions 
  setdiff(category_1, 
        tbl_df2$condition %>%unique)

## Notifications 
  # Table of Overall andd all provinces notifications 
            tbl_province_cat2<- tbl_df2%>%
              #filter( case_definition == "Confirmed" )%>%
              select(prov_ , condition)%>% 
                mutate(
                  condition = factor( condition , 
                                      levels = c(
                                        tbl_df2$condition %>%unique%>%sort)
                                        )
                  )%>%
              tbl_summary(by = prov_,
                          label = condition ~ "", 
                          percent = "row")%>%
              
              add_overall()%>%
              
              modify_header(all_stat_cols() ~ "**{level}**, n = {scales::number(n)} ({style_percent(p)}%)",
                            label = "**Category 2 Condition**")

# Table of total conditions 
  tbl_province_cat2_total_conditions<- tbl_df2%>%
              #filter( case_definition == "Confirmed" )%>%
              select( condition)%>% 
                mutate(
                  condition = factor( condition , 
                                      levels = c(
                                        tbl_df2$condition %>%unique%>%sort)
                                        )
                  )%>%
              tbl_summary(#by = prov_,
                          #label = condition ~ "", 
                          percent = "column"
                          )%>%
              
              #add_overall()%>%
              
              modify_header(all_stat_cols() ~ "**{level}**, n = {scales::number(n)} ({style_percent(p)}%)",
                            label = "**Category 2 Condition**")


   tbl_province_cat2_total_conditions[["table_body"]] %>%
              mutate(
                n = as.numeric(gsub("\\(.*", "", tbl_province_cat2_total_conditions[["table_body"]][["stat_0"]] )),
                n_percent = as.numeric(gsub("[^0-9.]+", "", gsub(".*\\((.*?)%\\).*", "\\1", tbl_province_cat2_total_conditions[["table_body"]][["stat_0"]]))),
                na.rm = TRUE
              ) %>%
              select( 
                label, 
                stat_0,
                n, 
                n_percent
              )%>%
              na.omit() %>%
              arrange(-n)%>%
              as.data.table()-> 
              tbl_province_cat2_total_conditions

tbl_province_cat2_total_conditions$label[1] -> max_cat2_disease # the most common condition
tbl_province_cat2_total_conditions$stat_0[1] -> max_cat2_disease_N # n(%) of that condition


# you need to find the province that had the most notificaitons for the most common notification
          tbl_df2[condition %in% max_cat2_disease]$prov_ %>%
            tabyl() %>% 
            arrange(-n) ->  prov_table
            
          
          prov_table%>%
            select(1) %>%
            slice(1) %>%
            pull() -> common_prov

            long_df2 <- tbl_province_cat2[["table_body"]][c(5, 7:15)]%>%na.omit() 

            tbl_df2$prov_%>%unique%>%sort ->prov_names
            names(long_df2) <- c("disease",prov_names)            
            long_df2
            
            longer2<-long_df2 %>%pivot_longer(cols = prov_names, values_to = "n")

            longer2 %>%
              filter( disease == max_cat2_disease)  %>%
            mutate( 
              prov = name, 
              stat_0 = n , 
              n = as.numeric(gsub("\\(.*)", "", n)),
              n_percent = as.numeric(gsub("[^0-9.]+", "", gsub(".*\\((.*?)%\\).*", "\\1", n))),
            )   %>%
            arrange( -n) -> 
            most_common_disease_in_prevalent_province

            most_common_disease_in_prevalent_province$stat_0[1]


blurb_cat1_notifications <- paste0(
  "**", max_cat2_disease, "** was the most common (", max_cat2_disease_N, ") category ", category_number, " notification **(suspected and confirmed)**. 
  The province with the highest number of notifications for ", max_cat2_disease, " was ", common_prov, " (",  most_common_disease_in_prevalent_province$stat_0[1],
 ")."
)



  # Confirmed 
    # Table 
            tbl_province_cat2<- tbl_df2%>%
              filter( case_definition == "Confirmed" )%>%
              select(prov_ , condition)%>% 
                mutate(
                  condition = factor( condition , 
                                      levels = c(
                                        tbl_df2$condition %>%unique%>%sort)
                                        )
                  )%>%
              tbl_summary(by = prov_,
                          label = condition ~ "", 
                          percent = "row")%>%
              
              add_overall()%>%
              
              modify_header(all_stat_cols() ~ "**{level}**, n = {scales::number(n)} ({style_percent(p)}%)",
                            label = "**Category 2 Condition**")
            
                tbl_province_cat2_total_conditions<- tbl_df2%>%
              filter( case_definition == "Confirmed" )%>%
              select( condition)%>% 
                mutate(
                  condition = factor( condition , 
                                      levels = c(
                                        tbl_df2$condition %>%unique%>%sort)
                                        )
                  )%>%
              tbl_summary(#by = prov_,
                          #label = condition ~ "", 
                          percent = "column"
                          )%>%
              
              #add_overall()%>%
              
              modify_header(all_stat_cols() ~ "**{level}**, n = {scales::number(n)} ({style_percent(p)}%)",
                            label = "**Category 2 Condition**")


  # Blurbs 
           tbl_province_cat2_total_conditions[["table_body"]] %>%
             mutate(
               n = as.numeric(gsub("\\(.*", "", tbl_province_cat2_total_conditions[["table_body"]][["stat_0"]])),
               n_percent = as.numeric(gsub("[^0-9.]+", "", gsub(".*\\((.*?)%\\).*", "\\1", tbl_province_cat2_total_conditions[["table_body"]][["stat_0"]]))),
               na.rm = TRUE
             ) %>%
             select(
               label,
               stat_0,
               n,
               n_percent
             ) %>%
             na.omit() %>%
             arrange(-n) %>%
             as.data.table() ->
           tbl_province_cat2_total_conditions

           tbl_province_cat2_total_conditions$label[1] -> max_cat2_disease # the most common condition
           tbl_province_cat2_total_conditions$stat_0[1] -> max_cat2_disease_N # n(%) of that condition


           # you need to find the province that had the most notificaitons for the most common notification
           tbl_df2$prov_ %>%
             tabyl() %>%
             arrange(-n) -> prov_table

           prov_table %>%
             select(1) %>%
             slice(1) %>%
             pull() -> common_prov

           long_df2 <- tbl_province_cat2[["table_body"]][c(5, 7:15)] %>% na.omit()

           tbl_df2$prov_ %>%
             unique() %>%
             sort() -> prov_names
           names(long_df2) <- c("disease", prov_names)
           long_df2
           longer2 <- long_df2 %>% pivot_longer(cols = prov_names, values_to = "n")

           longer2 %>%
             filter(disease == max_cat2_disease) %>%
             mutate(
               prov = name,
               stat_0 = n,
               n = as.numeric(gsub("\\(.*)", "", n)),
               n_percent = as.numeric(gsub("[^0-9.]+", "", gsub(".*\\((.*?)%\\).*", "\\1", n))),
             ) %>%
             arrange(-n) ->
           most_common_disease_in_prevalent_province


blurb_cat1_confirmed <- paste0(
  "**", max_cat2_disease, "** was the most common (", max_cat2_disease_N, ") category ", category_number, " notification **confirmed**. The province with the highest number of confirmed notifications for ",
  max_cat2_disease, " was ", most_common_disease_in_prevalent_province$prov[1], " ", most_common_disease_in_prevalent_province$stat_0[1]
)


print(cat(blurb_cat1_notifications, "\n", blurb_cat1_confirmed,""))


```

`r blurb_cat1_notifications` 
`r blurb_cat1_confirmed` 

### Table {.unnumbered}

```{r, warnings = FALSE, message=FALSE, fig.cap = "" }
category_number <- 1

conditions_category <- category_1 <- condition_df %>%
    filter(nmccategories %in% category_number) %>%
    select(condition) %>%
    pull()

category_1_sub <- conditions_category %>%
    gsub(
        "Cholera",
        "Cholera §", .
    ) %>%
    gsub(
        "Diphtheria",
        "Diphtheria *", .
    )

# setdiff(category_1_sub, case_type_tbl$condition%>%unique)
case_type_tbl <- df1 %>%
    filter(nmccategories %in% category_number) %>%
    mutate(condition = case_when(condition == "Cholera" ~ "Cholera §",
        condition == "Diphtheria" ~ "Diphtheria *",
        .default = condition
    )) %>%
    mutate(condition = factor(condition, levels = c(category_1_sub))) %>%
    mutate(case_type = if_else(case_type == "Merged Case", "Merged Case**", case_type)) %>%
    dplyr::select(condition, prov_) %>%
    mutate(`Total` = TRUE) %>%
    tbl_summary(.,
        by = prov_,
        missing = "no",
        # percent = "row",
        label = list(condition ~ ""),
        statistic = list(everything() ~ "{n}")
    ) %>%
    bold_labels() %>%
    modify_header(all_stat_cols() ~ "**{level}**",
        label = "Condition"
    ) %>%
    modify_footnote(update = everything() ~ NA)



epi_class_tbl <- df1 %>%
    filter(nmccategories %in% category_number) %>%
    mutate(condition = case_when(condition == "Cholera" ~ "Cholera §",
        condition == "Diphtheria" ~ "Diphtheria *",
        .default = condition
    )) %>%
    mutate(condition = factor(condition, levels = c(category_1_sub))) %>%
    # filter(epidemiological_classification == "Confirmed case")%>%
    dplyr::select(condition, case_definition) %>%
    mutate(`Total` = TRUE) %>%
    tbl_summary(.,
        by = case_definition,
        missing = "no",
        percent = "row",
        label = list(condition ~ ""),
        statistic = list(everything() ~ "{n}")
    ) %>%
    bold_labels() %>%
    modify_header(all_stat_cols() ~ "**{level}**",
        label = "Condition"
    ) %>%
    modify_footnote(update = everything() ~ NA)

# df1$censor%>%unique

epi_death_tbl <- df1 %>%
    filter(nmccategories %in% category_number) %>%
    mutate(condition = case_when(condition == "Cholera" ~ "Cholera §",
        condition == "Diphtheria" ~ "Diphtheria *",
        .default = condition
    )) %>%
    mutate(condition = factor(condition, levels = c(category_1_sub))) %>%
    # filter(epidemiological_classification == "Confirmed case")%>%
    # filter(case_definition %in% "Confirmed" )%>%
    filter(censor != "Not Deceased") %>%
    dplyr::select(condition, case_definition) %>%
    mutate(`Total` = TRUE) %>%
    tbl_summary(.,
        by = case_definition,
        missing = "no",
        percent = "row",
        label = list(condition ~ ""),
        statistic = list(everything() ~ "{n}")
    ) %>%
    bold_labels() %>%
    modify_header(all_stat_cols() ~ "**{level}**",
        label = "Condition"
    ) %>%
    modify_footnote(update = everything() ~ NA)

# CFR of all cases
epi_death_tbl <- df1 %>%
    filter(nmccategories %in% category_number) %>%
    mutate(condition = case_when(condition == "Cholera" ~ "Cholera §",
        condition == "Diphtheria" ~ "Diphtheria *",
        .default = condition
    )) %>%
    mutate(condition = factor(condition, levels = c(category_1_sub))) %>%
    # filter(epidemiological_classification == "Confirmed case")%>%
    # filter(case_definition %in% "Confirmed" )%>%
    #filter(censor != "Not Deceased") %>%
    dplyr::select(condition, censor) %>%
    mutate(`Total` = TRUE) %>%
    tbl_summary(.,
        by = censor,
        missing = "no",
        percent = "row",
        label = list(condition ~ ""),
        statistic = list(everything() ~ "{n}")
    ) %>%
    bold_labels() %>%
    modify_header(all_stat_cols() ~ "**{level}**",
        label = "Condition"
    ) %>%
    modify_footnote(update = everything() ~ NA)

  epi_cfr_tbl <- df1 %>%
    filter(nmccategories %in% category_number) %>%
    mutate(condition = case_when(condition == "Cholera" ~ "Cholera §",
        condition == "Diphtheria" ~ "Diphtheria *",
        .default = condition
    )) %>%
    mutate(condition = factor(condition, levels = c(category_1_sub))) %>%
    # filter(epidemiological_classification == "Confirmed case")%>%
    # filter(case_definition %in% "Confirmed" )%>%
    #filter(censor != "Not Deceased") %>%
    dplyr::select(condition, censor) %>%
    mutate( 
      censor = 
        if_else( 
          censor == "Deceased",
          "CFR",  # for case factality rate 
          "CAR" # for case alive rate
        )
    )%>%
    mutate(`Total` = TRUE) %>%
    tbl_summary(.,
        by = censor,
        missing = "no",
        percent = "row",
        label = list(condition ~ ""),
        statistic = list(everything() ~ "{p}%")
    ) %>%
    bold_labels() %>%
    modify_header(all_stat_cols() ~ "**{level}**",
        label = "Condition"
    ) %>%
    modify_footnote(update = everything() ~ NA)%>%
    modify_column_hide(columns = c("stat_1"))%>%
    modify_table_body(
        ~ .x %>%
            dplyr::mutate(
                stat_1 = gsub( "NA", "-", stat_1), 
                stat_2 = gsub( "NA", "-", stat_2)

            )
    )



merged_epi_classification_death <- tbl_merge(
    tbls = list(
      case_type_tbl, 
      #epi_class_tbl, 
      epi_death_tbl,
       epi_cfr_tbl),
    tab_spanner = c("**Provinces**", "**Vital Status**", "****")
) %>%
    modify_footnote(all_stat_cols() ~ "n; \n * Toxin producing results not available on NMC; \n § Serotype information not available on NMC")

# Used to add:
## ; \n ** Merged case represents a clinical and laboratory notification of the same person and was successfully linked and made into a single notification


merged_epi_classification <- tbl_merge(
    tbls = list(case_type_tbl, epi_class_tbl),
    tab_spanner = c("**Provinces, n**", "**Case Definition, n(%)**")
) %>%
    modify_footnote(all_stat_cols() ~ "n(%); \n * Toxin producing results not available on NMC; \n § Serotype information not avaialble on NMC;")


length <- merged_epi_classification_death[["table_body"]] %>% nrow()
merged_epi_classification_death[["table_body"]] <- merged_epi_classification_death[["table_body"]][2:length, ]



merged_epi_classification_death %>%
    as_flex_table() %>%
    flextable::set_caption(paste0("The number of notifications by province and number of notifications that are suspected and confirmed by vital status, ", format(reporting_date, "%B, %Y"))) %>% # Example: making the first row (header) bold
    fontsize(, size = 9, part = "header") %>%
    flextable::set_table_properties(layout = "autofit", width = 0.99) %>%
    theme_zebra() %>%
    bg(.,
        part = "header",
        bg  = "#A5CA64"
    ) %>%
    flextable::color(, color = "white", part = "header") %>%
    # create inner vertical borders in a thin white line
    border_inner_v(
        border = officer::fp_border(color = "white", width = 0.5),
        part = "all"
    )

# df%>%filter(condition == "Pertussis"& epidemiological_classification=="Confirmed case"& case_type == "Clinical notifications")%>%View()\newpage

### Plot {.unnumbered}

```{r, include = FALSE}

source("scripts_and_functions/dot_counts.R")
source("scripts_and_functions/gg2word.R")
source("scripts_and_functions/ggplot_experiments.R")

```

```{r,  fig.cap = paste0("Distribution of all Category 1 NMCs notifications by province notified during ", reporting_date_month_year,". *All notifications include both suspected and confirmed cases") ,   warnings = FALSE, message=FALSE}

gg2word_cond <- function( plot, directory_name) {
  
  dims<- c(9, 5.5)
  ## I found that for pptx presentations, dimensions of 9 and 5.5 worked well( basically landscape )
  dims[1]
  
  plot_name <- deparse(substitute(plot))
  
  ggsave(
    paste0(as.character(directory_name),"/",as.character(plot_name),".png"),
    suppressWarnings(plot + theme(plot.background = element_rect(fill = "white", color = "black", linewidth = 0.5))),
    width = dims[1],
    height = dims[2],
    dpi = 200
  )
  
  #Include the plot in the Quarto document
  knitr::include_graphics(paste0(as.character(directory_name),"/",as.character(plot_name),".png"))
  
}

load("plots/dot_nmc1.rda" )
gg2word_cond(dot_nmc1, "plots")

```



## Category 2 notifications {.unnumbered}

Category 2 conditions must be notified within 7 days of diagnosis. They are important to monitor disease burden trends. 

### Table {.unnumbered}

```{r , warnings = FALSE, message=FALSE, include = FALSE}
 


category_number <- 2

tbl_df2 <- df1 %>%filter(nmccategories ==category_number) %>%setDT() 

tbl_df2$condition%>%unique

conditions_category <- condition_df%>%filter( nmccategories %in% category_number)%>%select(condition)%>%
    mutate(condition = case_when(condition == "Cholera" ~ "Cholera §", 
                               condition == "Diphtheria" ~ "Diphtheria *", 
                               grepl("*tuberculosis*", ignore.case = TRUE, condition) ~ 
                                 paste0(condition, "*"),
                               .default = condition))%>%pull()

setdiff(conditions_category, unique(tbl_df2$condition))

tbl_province_cat2 <- tbl_df2 %>%
  select(prov_, condition) %>%
  mutate(condition = case_when(
    condition == "Cholera" ~ "Cholera §",
    condition == "Diphtheria" ~ "Diphtheria *",
    grepl("*tuberculosis*", ignore.case = TRUE, condition) ~ paste0(condition, "*"),
    TRUE ~ condition
  )) %>%
  mutate(condition = factor(condition, levels = conditions_category)) %>%
  tbl_summary(
    by = prov_,
    label = condition ~ "",
    #statistic = list(everything() ~ "{n}")
  ) %>%
  add_overall() %>%
  modify_header(
    all_stat_cols() ~ "**{level}**, n = {scales::number(n)} ({style_percent(p)}%)",
    label = "**Category 2 Condition**"
  )

# Blurbs
  tbl_province_cat2[["table_body"]] %>%
    mutate(
      label = gsub( "\\*", "", label) , 
      n = as.numeric(gsub(" ", "", gsub("\\(.*", "", tbl_province_cat2[["table_body"]][["stat_0"]]))),
      n_percent = as.numeric(gsub("[^0-9.]+", "", gsub(".*\\((.*?)%\\).*", "\\1", tbl_province_cat2[["table_body"]][["stat_0"]]))),
      na.rm = TRUE
    ) %>%
    select(
      label,
      stat_0,
      n,
      n_percent
    ) %>%
    na.omit() %>%
    arrange(-n) %>%
    as.data.table() ->
  tbl_province_cat2_total_conditions

  tbl_province_cat2_total_conditions$label[1] -> max_cat2_disease # the most common condition
    tbl_province_cat2_total_conditions$label[1] -> max_cat2_disease_filter # the most common condition
  tbl_province_cat2_total_conditions$stat_0[1] -> max_cat2_disease_N # n(%) of that condition

if (grepl("tubercul", ignore.case = TRUE, max_cat2_disease)) {
  max_cat2_disease <- gsub("Tuberculosis:", "", max_cat2_disease)
  max_cat2_disease <- stringr::str_to_title(max_cat2_disease)
  max_cat2_disease <- paste0(max_cat2_disease, " TB")
} else {
  max_cat2_disease
} 

tbl_df2$prov_ %>%
             tabyl() %>%
             arrange(-n) -> prov_table

           prov_table %>%
             select(1) %>%
             slice(1) %>%
             pull() -> common_prov

           long_df2 <- tbl_province_cat2[["table_body"]][c(5, 7:15)] %>% na.omit()

           tbl_df2$prov_ %>%
             unique() %>%
             sort() -> prov_names
           
           names(long_df2) <- c("disease", prov_names)
           long_df2
           longer2 <- long_df2 %>% pivot_longer(cols = prov_names, values_to = "n")


           longer2 %>%
             filter(grepl( max_cat2_disease_filter, disease, ignore.case = TRUE)) %>%
             mutate(
               prov = name,
                stat_0 = n,
                n = as.numeric(gsub(" ", "", gsub("\\(.*", "", n))), 
               n_percent = as.numeric(gsub("[^0-9.]+", "", gsub(".*\\((.*?)%\\).*", "\\1", n))),
             )%>%
 
             arrange(-n) ->
           most_common_disease_in_prevalent_province


blurb_cat2 <- paste0(
  "**", max_cat2_disease, "** was the most common (", max_cat2_disease_N, ") category ", category_number, " notification **confirmed**. The province with the highest number of confirmed notifications for **",
  max_cat2_disease, "** was ", most_common_disease_in_prevalent_province$prov[1], " ", most_common_disease_in_prevalent_province$stat_0[1]
)

```

`r blurb_cat2`



```{r, warnings = FALSE, message=FALSE, fig.cap = "" }
category_number <- 2

case_type_tbl <- df1 %>%
    filter(nmccategories %in% category_number) %>%
    mutate(condition = case_when(condition == "Cholera" ~ "Cholera §",
        condition == "Diphtheria" ~ "Diphtheria *",
        grepl("*tuberculosis*", ignore.case = TRUE, condition) ~
            paste0(condition, "*"),
        .default = condition
    )) %>%
    mutate(condition = factor(condition, levels = c(conditions_category))) %>%
    mutate(case_type = if_else(case_type == "Merged Case", "Merged Case**", case_type)) %>%
    dplyr::select(condition, prov_) %>%
    mutate(`Total` = TRUE) %>%
    tbl_summary(.,
        by = prov_,
        missing = "no",
        # percent = "row",
        label = list(condition ~ ""),
        statistic = list(everything() ~ "{n}")
    ) %>%
    bold_labels() %>%
    modify_header(all_stat_cols() ~ "**{level}**",
        label = "Condition"
    ) %>%
    modify_footnote(update = everything() ~ NA)


epi_class_tbl <- df1 %>%
    filter(nmccategories %in% category_number) %>%
    mutate(condition = case_when(condition == "Cholera" ~ "Cholera §",
        condition == "Diphtheria" ~ "Diphtheria *",
        grepl("tubercul", ignore.case = TRUE, condition) ~
            paste(condition, "*"),
        .default = condition
    )) %>%
    mutate(condition = factor(condition, levels = c(conditions_category))) %>%
    # filter(epidemiological_classification == "Confirmed case")%>%
    dplyr::select(condition, case_definition) %>%
    mutate(`Total` = TRUE) %>%
    tbl_summary(.,
        by = case_definition,
        missing = "no",
        percent = "row",
        label = list(condition ~ ""),
        statistic = list(everything() ~ "{n}")
    ) %>%
    bold_labels() %>%
    modify_header(all_stat_cols() ~ "**{level}**",
        label = "Condition"
    ) %>%
    modify_footnote(update = everything() ~ NA)

# df1$censor%>%unique

epi_death_tbl <- df1 %>%
    mutate(case_definition = factor(case_definition,
        levels = c("Confirmed", "Suspected")
    )) %>%
    filter(nmccategories %in% category_number) %>%
    mutate(condition = case_when(condition == "Cholera" ~ "Cholera §",
        condition == "Diphtheria" ~ "Diphtheria *",
        grepl("tubercul", ignore.case = TRUE, condition) ~
            paste(condition, "*"),
        .default = condition
    )) %>%
    mutate(condition = factor(condition, levels = c(conditions_category))) %>%
    # filter(epidemiological_classification == "Confirmed case")%>%
    # filter(case_definition %in% "Confirmed" )%>%
    filter(censor != "Not Deceased") %>%
    dplyr::select(condition, case_definition) %>%
    mutate(`Total` = TRUE) %>%
    tbl_summary(.,
        by = case_definition,
        missing = "no",
        percent = "row",
        label = list(condition ~ ""),
        statistic = list(everything() ~ "{n}")
    ) %>%
    bold_labels() %>%
    modify_header(all_stat_cols() ~ "**{level}**",
        label = "Condition"
    ) %>%
    modify_footnote(update = everything() ~ NA)

epi_death_tbl <- df1 %>%
    filter(nmccategories %in% category_number) %>%
    mutate(condition = case_when(condition == "Cholera" ~ "Cholera §",
        condition == "Diphtheria" ~ "Diphtheria *",
        grepl("*tuberculosis*", ignore.case = TRUE, condition) ~
            paste0(condition, "*"),
        .default = condition
    )) %>%
    mutate(condition = factor(condition, levels = c(conditions_category))) %>%
    # filter(epidemiological_classification == "Confirmed case")%>%
    # filter(case_definition %in% "Confirmed" )%>%
    # filter(censor != "Not Deceased") %>%
    dplyr::select(condition, censor) %>%
    mutate(`Total` = TRUE) %>%
    tbl_summary(.,
        by = censor,
        missing = "no",
        percent = "row",
        label = list(condition ~ ""),
        statistic = list(everything() ~ "{n}")
    ) %>%
    bold_labels() %>%
    modify_header(all_stat_cols() ~ "**{level}**",
        label = "Condition"
    ) %>%
    modify_footnote(update = everything() ~ NA)

epi_cfr_tbl <- df1 %>%
    filter(nmccategories %in% category_number) %>%
    mutate(condition = case_when(condition == "Cholera" ~ "Cholera §",
        condition == "Diphtheria" ~ "Diphtheria *",
        grepl("*tuberculosis*", ignore.case = TRUE, condition) ~
            paste0(condition, "*"),
        .default = condition
    )) %>%
    mutate(condition = factor(condition, levels = c(conditions_category))) %>%
    # filter(epidemiological_classification == "Confirmed case")%>%
    # filter(case_definition %in% "Confirmed" )%>%
    # filter(censor != "Not Deceased") %>%
    dplyr::select(condition, censor) %>%
    mutate(
        censor =
            if_else(
                censor == "Deceased",
                "CFR", # for case factality rate
                "CAR" # for case alive rate
            )
    ) %>%
    mutate(`Total` = TRUE) %>%
    tbl_summary(.,
        by = censor,
        missing = "no",
        percent = "row",
        label = list(condition ~ ""),
        statistic = list(everything() ~ "{p}%")
    ) %>%
    bold_labels() %>%
    modify_header(all_stat_cols() ~ "**{level}**",
        label = "Condition"
    ) %>%
    modify_footnote(update = everything() ~ NA) %>%
    modify_column_hide(columns = c("stat_1")) %>%
    modify_table_body(
        ~ .x %>%
            dplyr::mutate(
                stat_1 = gsub("NA", "-", stat_1), 
                stat_2 = gsub("NA", "-", stat_2)
            )
    )



merged_epi_classification_death <- tbl_merge(
    tbls = list(
        case_type_tbl,
        # epi_class_tbl,
        epi_death_tbl,
        epi_cfr_tbl
    ),
    tab_spanner = c("**Provinces**", "**Case**", "****")
) %>%
    modify_footnote(all_stat_cols() ~ "n; \n * TB module is under development to align with laboratory confirmed TB cases. Only TB cases that are manually notified (no laboratory surveillance) are reported.") %>%
    trim_tbl()



merged_epi_classification <- tbl_merge(
    tbls = list(case_type_tbl, epi_class_tbl),
    tab_spanner = c("**Provinces, n**", "**Case Definition, n(%)**")
) %>%
    modify_footnote(all_stat_cols() ~ "n; \n * TB module is under development to align with laboratory confirmed TB cases. Only TB cases that are manually notified (no laboratory surveillance) are reported.") %>%
    trim_tbl()





merged <- merged_epi_classification_death %>%
    as_flex_table() %>%
    flextable::set_caption("The number of notifications by province and number of notifications that are suspected and confirmed by vital status.") %>% # Example: making the first row (header) bold
    fontsize(, size = 9, part = "header") %>%
    flextable::set_table_properties(layout = "autofit", width = 0.99) %>%
    fontsize(, size = 8, part = "all") %>%
    flextable::set_table_properties(layout = "autofit", width = 0.99) %>%
    set_table_properties() %>%
    autofit(.) %>%
    padding(., padding = 0.1, part = "all") %>%
    width(.,
        j = 1, width = 5, unit = "cm"
    ) %>%
    width(.,
        j = 2, width = 1.3, unit = "cm"
    ) %>%
    width(.,
        j = 3, width = 1.3, unit = "cm"
    ) %>%
    width(.,
        j = 4, width = 1.3, unit = "cm"
    ) %>%
    width(.,
        j = 5, width = 1.3, unit = "cm"
    ) %>%
    width(.,
        j = 6, width = 1.3, unit = "cm"
    ) %>%
    width(.,
        j = 7, width = 1.3, unit = "cm"
    ) %>%
    width(.,
        j = 8, width = 1.3, unit = "cm"
    ) %>%
    width(.,
        j = 9, width = 1.3, unit = "cm"
    ) %>%
    width(.,
        j = 10, width = 1.3, unit = "cm"
    ) %>%
    width(.,
        j = 11, width = 1.9, unit = "cm"
    ) %>%
    width(.,
        j = 12, width = 1.9, unit = "cm"
    ) %>%
    width(.,
        j = 13, width = 1.9, unit = "cm"
    )
# width(.,
#   j = 14, width = 1.9, unit = "cm")


# for merging cells like in TB where there is no real suspected and confirmed

merge_cols <- function() {
    merged %>%
        merge_at(., i = 19, j = 11:12, part = "body") %>%
        merge_at(., i = 18, j = 11:12, part = "body") %>%
        merge_at(., i = 17, j = 11:12, part = "body") %>%
        merge_at(., i = 16, j = 11:12, part = "body") %>%
        merge_at(., i = 19, j = 13:14, part = "body") %>%
        merge_at(., i = 18, j = 13:14, part = "body") %>%
        merge_at(., i = 17, j = 13:14, part = "body") %>%
        merge_at(., i = 16, j = 13:14, part = "body") %>%
        bg(., i = 16:19, j = 11:13, bg = "grey80", part = "body") %>%
        theme_zebra() %>%
        bg(.,
            part = "header",
            bg  = "#A5CA64"
        ) %>%
        flextable::color(, color = "white", part = "header")
}

merged %>%
    bg(., i = 16:19, j = 11:13, bg = "grey80", part = "body") %>%
    theme_zebra() %>%
    bg(.,
        part = "header",
        bg  = "#A5CA64"
    ) %>%
    flextable::color(, color = "white", part = "header")

# df%>%filter(condition == "Pertussis"& epidemiological_classification=="Confirmed case"& case_type == "Clinical notifications")%>%View()
```

\newpage

### Plot {.unnumbered}

```{r,  fig.cap = paste0("Distribution of all Category 2 NMCs notifications by province notified during ", reporting_date_month_year,". *All notifications include both suspected and confirmed  cases") ,   warnings = FALSE, message=FALSE}

load( "plots/dot_nmc2.rda" )

gg2word_cond(dot_nmc2, "plots")

```



# NMC app use statistics {.unnumbered}

```{r tbl-cat-bycase, fig.cap ="" }

#tabel1<- xtabs(~nmccategories + case_source , data = df1)

#age_group_5_9 <- table1all[["table_body"]][["stat_0"]][grep("^5-9", table1all[["table_body"]][["label"]], ignore.case = TRUE)]

#knitr::kable(tabel1, "pipe", padding = 2, colnames = c("NMC categories", "Number of cases", "Proportion") ,
#  align = c("l", "c", "c"), caption = "Table 1: Description of NMC notifications by case source, ")

library(flextable)

# Add styling or formatting to the flextable if desired
table_flex <- table_summary %>%as_flex_table()%>%
  flextable::set_caption("Description of NMC notifications by case source") %>%# Example: making the first row (header) bold
    fontsize(, size = 9, part = "header")%>%
  flextable::set_table_properties(layout = "autofit", width = 0.99)

# Print the flextable

#### Take out superscript. (1)


#df_length<- nrow(table_flex[["body"]][["dataset"]])

#table_flex[["body"]][["dataset"]][1,1]<- NA

table_flex 
```

\newpage

## Notification types and merging {.unnumbered}

```{r, echo=FALSE, fig.cap =  paste0("Case source of clinical notifications ",  reporting_date_month_year) ,   warnings = FALSE, message=FALSE}
#df1 <- df%>%filter(Back_capture %in% c("Current", "Back Captured"))
#df1$province %>%unique

# So, we have clinical and lab notificaitons. 

# clinical ones canbe made on certain platforms and this may differ by public nd pirvate sector 

df1 %>%
  filter(
    case_type %in% "Clinical notifications",
    facility_sector %in% c("Public", "Private")
  ) %>%
  select(
    facility_sector,
    case_source
  ) %>%
  tbl_summary(
    by = facility_sector,
  ) %>%
  add_p()-> tbl_case_source


# Summarize data by month and case_source
monthly_counts <- new_master %>%
  filter( 
    facility_sector %in% c("Public", "Private"),
    case_source %in% c( "Web", "Android", "iOS", "Paper-based")
    ) %>%
  filter(
    !condition %in% "Covid-19",
    case_type %in% "Clinical notifications",
    facility_sector %in% c("Public", "Private")
  ) %>%
  mutate(month = floor_date(as.Date(notification_date), "month")) %>%
  count(month, case_source, facility_sector)

# Identify the last month for each case_source for labeling
end_labels <- monthly_counts %>%
  group_by(case_source) %>%
  filter(month == max(month)) %>%
  ungroup()

# Plot
ggplot(monthly_counts, aes(x = month, y = n, color = case_source)) +
  geom_line(size = 1) +
  ggrepel::geom_text_repel(
    data = end_labels,
    aes(label = case_source),
                    hjust = -0.1,
                    nudge_x = 25,
                    direction = "y",
                    size = 3,
                    segment.color = "grey50"
                  )+
  facet_wrap( 
    ~ facility_sector, 
    ncol = 1, 
    scales = "free_y", 
    #switch = "y", 
    strip.position = "right"
  )+
  scale_x_date(
    date_labels = "%Y", 
    date_breaks = "1 year", 
    expand = expansion(mult = c(0.01, 0.1))) +
    labs( 
    x = "Notification Date",
    y = "Number of Notifications",
    )+
  theme_minimal() +
  # imporve the guide of the legend so it is all on one row 
  guides( 
    color = guide_legend(
      nrow = 1
    )
  )+
    theme(
      plot.title = element_text(size = 10, face = "bold"),
      axis.title.x = element_text(size = 9),
      axis.title.y = element_text(size = 9),
      legend.title = element_text(size = 8),
      legend.text = element_text(size = 7),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.border = element_blank(),
      panel.background = element_blank()
    ) +
      as_excel() +
      theme(
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.ticks = element_line(size = 0.15, color = "grey20")
      ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), 
    strip.text.y.right = element_text(angle = 0, size = 10, hjust = 0), 

    legend.position = "bottom") +
  labs(title = "App Utilisation by Case Source Over Time", x = "Notification Month", color = "Case Source")-> 
  plot_case_source


# Save the plot

gg2word_cond(
  plot_case_source, 
  "plots"
)
  



```

```{r,  warnings = FALSE, message=FALSE, include = FALSE}
#names(df1)
tabl_sectorBysource <- df1%>%select(source_2, facility_sector) %>%tbl_summary(by = source_2)%>%add_overall
#tabl_sectorBysource
#tabl_sectorBysource[["table_body"]][["stat_1"]]
#tabl_sectorBysource[["table_body"]][["label"]]

private_clinical_notifications<-  tabl_sectorBysource[["table_body"]][["stat_1"]][grep("^private", tabl_sectorBysource[["table_body"]][["label"]], ignore.case = TRUE)]

all_clinical_notifications <- tabl_sectorBysource[["table_body"]][["stat_1"]][grep("*public*", tabl_sectorBysource[["table_body"]][["label"]], ignore.case = TRUE)]


```

```{r, include=FALSE}

capture_type_tbl <- df1%>%filter(case_source != "Lab") %>%select( prov_, capture_type2, ) %>%tbl_summary(missing = "ifany", 
                                                                                                         by = capture_type2)%>%
modify_header(all_stat_cols() ~ "**{level}**")

capture_sector_tbl<- df1%>%filter(case_type != "Lab") %>%select( prov_, facility_sector, ) %>%tbl_summary(missing = "ifany",
                                                                                                             by = facility_sector)%>%
modify_header(all_stat_cols() ~ "**{level}**")

practice1 <- tbl_merge(tbls= 
            list(capture_type_tbl, capture_sector_tbl), 
          tab_spanner = c("**Capture Type**", "**Sector**"))%>%
  as_flex_table%>%
    fontsize(, size = 9, part = "header")%>%
  flextable::set_table_properties(layout = "autofit", width = 0.99)

df1$capture_type2%>%unique

df1%>%
      filter(capture_type2 != "Microstrategy/SDW",
      facility_sector %in% c("Public", "Private")) %>%
      select( prov_, capture_type2,facility_sector )%>%
      tbl_strata(,
                          strata = capture_type2,
           percent = "row",
                          .tbl_fun =
                            ~ .x %>%
        tbl_summary(by = facility_sector, missing = "no", percent = "row"
                    ) ,
        #.combine_with = "tbl_stack"
    #.header = "**{strata}**, N = {n}"
  )%>%
  as_flex_table%>%
  fontsize(., size = 9, part = "header")%>%
  flextable::set_table_properties(layout = "autofit", width = 0.99)


grouped<- df1%>%filter(capture_type2 != "Microstrategy/SDW") %>%select( prov_, capture_type2,facility_sector )%>%
  group_by(prov_, capture_type2,facility_sector )%>%
  summarise(count = n())


#df1$prov_%>%unique

#df1 %>%filter(is.na(prov_))


tbl<-df1%>%
  filter(!grepl("lab", ignore.case = TRUE, case_type)) %>%
                                       
  select( prov_, capture_type2,facility_sector )%>%
  mutate( app_sector = case_when( capture_type2 == "App" & facility_sector == "Private" ~ "App - Private", 
                                  capture_type2 == "App" & facility_sector == "Public" ~ "App - Public",
                                  capture_type2 == "Paper-based" & facility_sector == "Private" ~ "Paper-based - Private",
                                  capture_type2 == "Paper-based" & facility_sector == "Public" ~ "Paper-based - Public"))%>%
  select(prov_, app_sector)%>%
  tbl_summary(by = app_sector, 
              percent = "row",
              label = list( prov_ ~ "")
              )%>%
      modify_header(all_stat_cols() ~ "**{level}**, \n n = {scales::number(n)}",
                label = "**Province**")%>%
  add_overall( statistic = ~"{n}",)%>%
  modify_footnote(update = everything() ~ NA)
  


length<- tbl[["table_body"]]%>%nrow()
tbl[["table_body"]]<- tbl[["table_body"]][2:length,]

tbl[["table_body"]]<- tbl[["table_body"]]%>% 
  mutate( n = 
            as.numeric(gsub( " ", "", gsub("\\(.*?\\)", "", tbl[["table_body"]][["stat_0"]])), na.rm= T))%>%
  arrange(-n)

#tbl[["table_body"]][["stat_0"]]

n_app_notifications <- sum(tbl[["table_body"]][["n"]][c(1, 2)], na.rm = TRUE)%>%style_number() %>%as.character()
perc_app_notifications <-  round((sum(tbl[["table_body"]][["n"]][c(1, 2)]))/ (nrow(df1)) * 100 , 0)

paste0( "..compared to ", 
       n_app_notifications, " app notifications out of ", nrow(df1), " total notifications (", perc_app_notifications, "%)")
# let us try and improve the tables and figures of this section. More general, better visuals and useful info. POtentially do circles of how differnt app utilisation eithe rfor national or by province. 
```
There were `r private_clinical_notifications` clinical notifications from the private sector (i.e. private hospitals, private practice and mining industry) compared to `r all_clinical_notifications` in the public sector. Clinical notifications using the NMC Reporting Application made up `r n_app_notifications` (`r perc_app_notifications`%) (more details in Table \@ref(tab:tab-notifications) ).

```{r}
#| include: false
# to adress mabores comment

df1%>%group_by(source_2, facility_sector)%>%
  summarise( count = n())

# totals
df1%>%group_by(source_2)%>%
  summarise( count = n())%>%
  ungroup() %>%
  mutate()

df1%>%select(nmccategories, source_2)%>%
tbl_summary(by = source_2, 
            percent = "row", 
            label = list(nmccategories ~ "") )%>%
  modify_header(label = "NMC Categories")%>%
  modify_footnote(update = everything() ~ NA)

```



```{r  tab-notifications, warnings = FALSE, message=FALSE, fig.cap = ""}

# df3 <- subset(df1, df1$case_type!="Lab")

#tabel1<- xtabs(~province +  case_type, data = df3)
#tabel2<- xtabs(~province +  facility_sector, data = df3)


#Capsecttable <-cbind(tabel1,tabel2)
#knitr::kable(Capsecttable, align = "ccccc",caption = "**Table 2: Clinical notifications notified by provinces by Capture type and sector, **" )

# Apply font style and font size to flextable

#### this table needs to be capture_type ( app vs paper based )


### change the case_source to case_soruce2 which combines, andorid, Ios, 

tbl%>%
  as_flex_table%>%
  fontsize(., size = 9, part = "header")%>%
  flextable::set_table_properties(layout = "autofit", width = 0.99)%>%
  flextable::set_caption("Clinical notifications notified by provinces, reporting platform, and sector")



tbl_cross<- df1%>%filter(capture_type2 != "Microstrategy/SDW") %>%select( prov_, capture_type2,facility_sector )%>%
  mutate( app_sector = case_when( capture_type2 == "App" & facility_sector == "Private" ~ "App - Private", 
                                  capture_type2 == "App" & facility_sector == "Public" ~ "App - Public",
                                  capture_type2 == "Paper-based" & facility_sector == "Private" ~ "Paper-based - Private",
                                  capture_type2 == "Paper-based" & facility_sector == "Public" ~ "Paper-based - Public"))%>%
  select(prov_, app_sector)%>%
  tbl_cross(row = prov_, 
            col = app_sector, 
            percent = "cell", 
            label = list(prov_~"", app_sector~"Reporting Platform"))%>%
  bold_labels()%>%
   as_flex_table%>%
  fontsize(., size = 9, part = "header")%>%
  flextable::set_table_properties(layout = "autofit", width = 0.99)%>%
  flextable::set_caption("Clinical notifications notified by provinces, reporting platform, and sector")

  #compose(., i=1, j=1, value = as_paragraph("Province"))

  #tbl_cross%>%compose(., i=2, j=1, value = as_paragraph("Province"), part = "body")
  
  #tbl_cross%>%compose(x = .,i = 1 , value = as_paragraph("Reporting Platform"), part = "header")
```

\newpage

## The average active users on the NMC App {.unnumbered}


```{r}
#| label: fig-nmc-app-users
#| fig.cap: Authorised users and average active users of the NMC Reporting App by month of notification, December 2020-January 2025
library(tidyverse)
# Load libraries
library(tidyverse)
library(ggh4x)
library(ggrepel)

# Input data
excel_users <- tribble(
    ~Year, ~Month, ~Average_active_users, ~Authorised_users,
    2020, "Oct", 1, NA,
    2020, "Nov", 2, NA,
    2020, "Dec", 9, 16,
    2021, "Jan", 19, 72,
    2021, "Feb", 39, 134,
    2021, "Mar", 57, 179,
    2021, "Apr", 86, 561,
    2021, "May", 128, 385,
    2021, "Jun", 195, 508,
    2021, "Jul", 248, 416,
    2021, "Aug", 266, 488,
    2021, "Sep", 236, 531,
    2021, "Oct", 154, 293,
    2021, "Nov", 156, 389,
    2021, "Dec", 315, 539,
    2022, "Jan", 259, 406,
    2022, "Feb", 247, 652,
    2022, "Mar", 214, 428,
    2022, "Apr", 200, 468,
    2022, "May", 325, 747,
    2022, "Jun", 279, 988,
    2022, "Jul", 289, 1075,
    2022, "Aug", 312, 1186,
    2022, "Sep", 322, 963,
    2022, "Oct", 311, 994,
    2022, "Nov", 374, 974,
    2022, "Dec", 214, 249,
    2023, "Jan", 289, 581,
    2023, "Feb", 336, 722,
    2023, "Mar", 371, 1061,
    2023, "Apr", 303, 839,
    2023, "May", 402, 878,
    2023, "Jun", 404, 974,
    2023, "Jul", 338, 657,
    2023, "Aug", 397, 908,
    2023, "Sep", 396, 679,
    2023, "Oct", 439, 810,
    2023, "Nov", 445, 370,
    2023, "Dec", 290, 321,
    2024, "Jan", 414, 824,
    2024, "Feb", 475, 1019,
    2024, "Mar", 371, 545,
    2024, "Apr", 396, 676,
    2024, "May", 410, 637,
    2024, "Jun", 343, 454,
    2024, "Jul", 377, 660,
    2024, "Aug", 432, 840,
    2024, "Sep", 505, 914,
    2024, "Oct", 561, 1101,
    2024, "Nov", 505, 596,
    2024, "Dec", 337, 299,
    2025, "Jan", 418, 581,
    2025, "Feb", 445, 718,
    2025, "Mar", 412, 591,
    2025, "Apr", 395, 647, 
    2025, "May",  416, 582, 
    2025, "Jun",  403, 451, 
    2025, "Jul",  482, 708, 
    2025, "Aug",  476, 700, 
    2025, "Sep",  519, 653, 
    2025, "Oct",  521, 695
)

# Convert Month to ordered factor and create a Date column
excel_users <- excel_users %>%
    mutate(
        Month = factor(Month, levels = c(
            "Jan", "Feb", "Mar", "Apr", "May", "Jun",
            "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
        )),
        Date = as.Date(paste(Year, Month, "1"), format = "%Y %b %d")
    )


# Identify latest month for labeling
latest <- excel_users %>% filter(Date == max(Date, na.rm = TRUE))

# Plot with continuous line, facets, and label for latest point
ggplot(excel_users, aes(x = Date)) +
    # Bars
    geom_col(aes(y = Average_active_users, fill = "Average active users"), width = 25) +
    # Single continuous line for authorised users
    geom_line(aes(y = Authorised_users, color = "Authorised users", group = 1), size = 1) +
    geom_point(aes(y = Authorised_users, color = "Authorised users"), size = 2) +
    # Latest point label with segment
    geom_label_repel(
        data = latest,
        aes(
            x = Date, y = Authorised_users,
            label = paste0(Authorised_users)
        ),
        nudge_x = 90, hjust = 0,
        nudge_y = 0,
        segment.size = 0.3,
        segment.color = "grey50",
        fill = "royalblue", color = "white"
    ) +
    geom_label_repel(
        data = latest,
        aes(
            x = Date, y = Average_active_users,
            label = paste0(Average_active_users)
        ),
        nudge_x = 90, hjust = 0,
        nudge_y = 0,
        segment.size = 0.3,
        segment.color = "grey50",
        fill = "forestgreen", color = "white"
    ) +

    # Scales and labels
    scale_fill_manual(name = NULL, values = "forestgreen") +
    scale_color_manual(name = NULL, values = "royalblue") +
    scale_x_date(
        date_breaks = "1 month", date_labels = "%b",
        expand = expansion(add = c(0, 0))
    ) +
    scale_y_continuous(labels = scales::comma, expand = expansion(mult = c(0, 0.1)))+
labs(x = "Month of notification", y = "Users (No.)") +
    # Facet by Year, free space
    ggh4x::facet_nested(~Year, scales = "free", space = "free_x", switch = "x") +
    # Allow labels to draw outside panels
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(
        plot.margin = margin(t = 5, r = 40, b = 5, l = 5, unit = "pt"),
        panel.clip = "off",
        legend.position = "bottom",
        axis.text.x = element_text(vjust = 0.5, angle = 90),
        strip.placement = "outside",
        panel.spacing = unit(0.17, "lines"),
        strip.background = element_rect(color = NA, fill = NA)
    )-> nmc_app_users_plot

# Save the plot
gg2word_cond(nmc_app_users_plot, "plots")


```

There were `r latest$Average_active_users` average active users, and `r latest$Authorised_users` newly authorised users of the NMC App in `r reporting_date_month_year`

\newpage 

## Newly registered users {.unnumbered}

Figure \@ref(fig:fig-users) shows the trends of newly registered users and their occupation. 
```{r, include = FALSE}

Month_reporting <- as_date("2024-09-01")
path <- path.expand("~/Downloads") # find the downloads directory on MacOS
path <- getwd()

list.files( path , pattern ="NMC_REG*.")%>%file.info()-> file_info
file_info

file_info$file_name <- row.names(file_info)

file_info%>%as.data.table()%>%arrange( mtime) -> file_info_dt
file_info_dt[nrow(file_info_dt)]$file_name -> file_name
#file_info_dt[["mtime"]]

#file_info_dt["mtime"]

users<-NULL
users <- read_csv(paste0(path, "/", file_name)) %>% clean_names()



users%>%filter(
  !is.na(registered_date),
  !is.na(occupation),
  !rejected %in% "Yes")%>%
  rename( condition = occupation) %>%
  filter( 
    as.numeric(as_date(registered_date))>as.numeric(as_date("2021-01-15")))->
    users

df_users<- epicurve_df(users, 
                       date_index = "registered_date", 
                       grouping_vars = "condition")%>%
  mutate( 
    #condition = factor( condition, levels = factor_arrange),
          #year = (as_year(as.numeric(year)))
  )

  as.numeric(as_year(Sys.Date() )) 

df_users%>%
  filter( 
    year %in% as.factor(2021:as.numeric(as_year(Sys.Date())))
  )-> df_users

output<- plot_epicurve_df(df_users, 
                          x_axis_option = "epiweeks", 
                          grouping_vars = "condition",
                          )


new_users_plot<- output$plot

```


```{r, fig-users, fig.cap = paste0("Trends of new users by occupation who registeered on NMC, in South Africa, January, 2022-", reporting_date_month) }

gg2word_cond(new_users_plot, "plots")
```



```{r, tbl-users, fig.cap = paste0("Trends of new users by occupation who registeered on NMC, in South Africa, January, 2022-", reporting_date_month) }


#users%>%glimpse() 
#users$condition%>%tabyl() %>%arrange(-n) 

users %>%
mutate( 
  year = as.numeric(as_year(registered_date)),
)%>%
  select( 
    condition, 
    year
  )%>%
  tbl_summary( 
    by = year, 
    sort = list( 
      condition ~ "frequency"
    ), 
    label = list(
      condition ~ "Occupation"
    )
  )%>%
  add_overall() %>%
  modify_header(
    all_stat_cols() ~ "**{level}**\nn = {scales::number(n)} ({style_percent(p)}%)",
    label = ""
  )%>%
  as_flex_table %>%
  fontsize(, size = 9, part = "header") %>%
  flextable::set_table_properties(layout = "autofit", width = 0.99) %>%
  flextable::set_caption(paste0("The occupation of newly registered users ", reporting_date_month_year))


  
```


\newpage

## Data quality {.unnumbered}

## Completeness  {.unnumbered}

```{r, warnings = FALSE, message=FALSE, fig.cap = ""}

vars <- c("folder_no", "patient_name", "patient_surname", "symptom_date", "diagnosis_date", "patient_vital_status")
#vars <- setdiff(names(df1)[1:(length(df1)-2)],#vars to include 
#                c(names(df1)[16] , "", "edr_GexpertDate")#vars to exclude 
#                )

# check 

missing_df <- df1 %>%
  mutate(across(all_of(vars), .fns = ~ ifelse(is.na(.) | grepl("Unknown", ignore.case = TRUE, . ), 0, 1)
                                              #levels = c("Missing", "Present")
                                              
                )
         )%>%
    mutate(case_source1 = factor(case_when(grepl("iOS|Web|Android",df1$case_source ) ~ "App",
                                  grepl("*Paper*", df1$case_source ) ~ "Paper-based",
           grepl("micro", ignore.case = TRUE, case_source) ~ "Laboratory notification"
           ), levels = c("App", "Paper-based", "Laboratory notification"))
           )
  


tbl_missing_df <- missing_df %>%dplyr::select(
  folder_no, patient_name,patient_surname,patient_surname,symptom_date, diagnosis_date, patient_vital_status, case_source1)%>%
#  mutate(across(everything(), ~ ifelse(grepl("unknown", ignore.case = TRUE), NA, 0)))%>%
  tbl_summary(
              missing = "no", 
              by = case_source1,
              label = list (folder_no ~ "Folder Number", 
                            patient_name ~ "First Name", 
                            patient_surname ~ "Surname", 
                            symptom_date ~ "Symptom Onset Date", 
                            diagnosis_date ~"Date of Diagnosis",
                            patient_vital_status ~ "Vital Status"))%>%
  modify_footnote(update = everything() ~ NA)%>%
  modify_header(label = "")%>%
  bold_labels()%>%as_flex_table%>%
    fontsize(, size = 9, part = "header")%>%
  flextable::set_table_properties(layout = "autofit", width = 0.99)%>%
  flextable::set_caption(paste0("NMC data completeness of clinical notifications on both reporting platforms, notified during ", reporting_date_month_year)) 

#tbl_missing_df[["table_body"]][["var_label"]] <- str_to_title(str_replace_all(tbl_missing_df[["table_body"]][["var_label"]],"_", " "))


```



```{r tbl-notification, include = FALSE ,warnings = FALSE, message=FALSE, fig.cap = ""}

tbl_notifications<- df%>%
  select(nmccategories, time_to_notification) %>%
  mutate(time_to_notification = as.numeric(time_to_notification) )%>%

  tbl_summary(by= nmccategories, 
            label = list(time_to_notification ~ "Time to Notification"), 
            digits  = list(time_to_notification ~ c(0, 0))
            )  



cat1_notif_time<- tbl_notifications[["table_body"]][["stat_1"]][1]


tbl_notifications%>%as_flex_table()%>%
  flextable::set_caption("Time to Notification in days by NMC category.") %>%# Example: making the first row (header) bold
    fontsize(, size = 9, part = "header")%>%
  flextable::set_table_properties(layout = "autofit", width = 0.99)

```

\newpage

## ID number completeness {.unnumbered}

```{r tbl-qualID, warnings = FALSE, message=FALSE}


ID_df<- df1 %>%mutate( id_length = ifelse( is.na(patient_id_no) , 0 ,  nchar(patient_id_no)))

#xtabs(~ id_length , data = ID_df , addNA = T)

# ID NUmber length 
ID_length_tbl<- ID_df %>%
  dplyr::select(
                #HFcomplete, 
                #patient_admission_status, 
                case_source, 
               
                id_length)%>%
  tbl_summary(., 
              missing = "ifany", 
              type = everything() ~ "categorical",
              #list( everything() ~  "{mean} ({sd})") ,
              by = case_source, 
              label = list(id_length ~ ""))%>%modify_header(label =  "**Length of ID number**")%>%trim_tbl()


ID_length_tbl$table_body$label<- ID_length_tbl$table_body$label%>%gsub("^0", "Not complete", . )

ID_length_tbl%>%as_flex_table()%>%
  flextable::set_caption(paste0("Length of ID numbers inputted on NMC system during", reporting_date_month_year)) %>%# Example: making the first row (header) bold
    fontsize(, size = 9, part = "header")%>%
  flextable::set_table_properties(layout = "autofit", width = 0.99)

```





```{r tbl-qualsymps,  warnings = FALSE, message=FALSE, include = FALSE, evaluate = FALSE}

#\newpage

## Symptomatology {.unnumbered}

symptoms_split<- df1$symptoms%>%
  strsplit(., "\\|")%>%
  unlist()%>%
  unique%>%
  na.omit

df1_new <- data.frame(df1)


symptoms_list <- c(
  "Muscle weakness", 
  "Other", 
  "Rice-water stools",  
  "Vomiting",
  "Fever", "Headache", 
  "Tiredness / Body malaise",
  "Loss of weight", 
  "Night Sweats",
  "Flu like symptoms", 
  "Loss of appetite",
  "Maculopapular rash", 
  "Cough", 
  "Conjuctivitis", 
  "Coryza (running nose)",
  "Paroxysmal coughing", 
  "Acute febrile illness", 
  "Inspirational whoop", 
  "Chest pains", 
  "Weakness", 
  "Shortness of breath"
)

# Create separate columns for each unique symptom and filter them

for (symptom in symptoms_split) {
  df1_new <- df1_new %>%
    mutate(!!symptom := grepl(symptom, df1$symptoms))
}



df1_new <- df1_new %>%
  mutate('No Symptoms Reported' = rowSums(select(df1_new, symptoms_split), na.rm = T) == 0)


df1_new <- df1_new %>%
  mutate(across(all_of(c('No Symptoms Reported', symptoms_split)), ~if_else(. == TRUE, 1, 0)))

df1_new%>%names()
df1_new$nmccategories
symptomsByCat_tbl<-df1_new[1:100,]%>% #filter(source_2 == "Clinical & Merged")%>%
 # dplyr::select(all_of(c("nmccategories", vars(symptoms_split))) %>%
  mutate(nmccategories = paste0("Category " ,nmccategories ))%>%
  tbl_summary(., 
              sort = everything() ~ "frequency",
              by = nmccategories,
              
  )%>%add_overall()

#symptomsByCat_tbl[["table_body"]][["label"]]<- c("", "Category 1", "Category 2",  "Category 3")
symptomsByCat_tbl[["table_body"]]<- symptomsByCat_tbl[["table_body"]]%>% 
  mutate( n = 
            as.numeric(gsub( " ", "", gsub("\\(.*?\\)", "", symptomsByCat_tbl[["table_body"]][["stat_0"]])), na.rm= T))%>%
  arrange(-n)


ft<-symptomsByCat_tbl%>%as_flex_table()%>%
  flextable::set_caption("Symptoms of patients clinically notified and merged with lab notifications to the NMC") %>%# Example: making the first row (header) bold
    fontsize(, size = 9, part = "header")%>%
  flextable::set_table_properties(layout = "autofit", width = 0.99)

# print the flextable but only the columns that dont have a zero in the second column
ft[["body"]][["dataset"]]<- ft[["body"]][["dataset"]][2:24,]

```

\newpage

## Hospital Form Completeness {.unnumbered}

```{r, include=FALSE}

source("Hosptial_completeness_graphs.r")
```

```{r  , warnings = FALSE, message=FALSE, fig.cap = paste0("The number of completed hospital forms among category 1 conditions on NMC, in South Africa, January, 2022-", reporting_date_month, ". The hospital form was implemented in the beginning of 2023 but has been hindered by budget constraints") }

#df1$HFcomplete%>%unique
#df1$patient_admission_status%>%unique
load("plots/proportions_completeness_plot.rda")
gg2word_cond(proportions_completeness_plot, "plots")

```

```{r  , warnings = FALSE, message=FALSE, fig.cap = ""}
#df1$HFcomplete%>%unique
#df1$patient_admission_status%>%unique


hf_tbl<- df1 %>% 
    filter(patient_admission_status == "Inpatient" & 
         nmccategories == 1)%>%
  mutate(
         condition = factor( condition, levels = category_1_sub ))%>%
  
  select(hosptal_completeness_cat,  condition)%>%


               tbl_summary(by = hosptal_completeness_cat
                           )%>%
               modify_header(label = "**Hospital Form Completed**"
                             )%>%
               modify_header(all_stat_cols() ~ "**{level}**, \nn = {scales::number(n)} ({style_percent(p)}%)")%>%
               modify_footnote(update = everything() ~ NA)%>%trim_tbl()

# need to get the "charactersitci" to change 


hf_tbl%>%
  as_flex_table()%>%
  fontsize(, size = 9, part = "header")%>%
  flextable::set_table_properties(layout = "autofit", width = 1)%>%
  flextable::set_caption(paste0("Completion of hospitalisation form for notifications reported as inpatients with category 1 conditions.", reporting_date_month_year," \\\n Complete refers to >80% of variables completed."))
  


#hf_complete_plot<- df1%>% select(HFcomplete, patient_admission_status)%>%
#  filter(!patient_admission_status %in% c("Outpatient", NA, "Unknown"))%>%
#  group_by(HFcomplete, patient_admission_status) %>%
#  summarize(count = n()) %>%
##  ggplot(aes(x = patient_admission_status, y = count, fill = HFcomplete)) +
#  geom_bar(stat = "identity", position = "dodge") +
#  labs(x = "Patient Admission Status", y = "Count", fill = "Hospital For Completed") +
#  theme_classic()

#ggsave(
#    "hf_complete_plot.png",
#    suppressWarnings(hf_complete_plot + theme(plot.background = element_rect(fill = "white", color = "black", linewidth = 0.5))),
#    width = 7,
#    height = 4,
#    dpi = 1000
#  )
  
   #Include the plot in the Quarto document
#  knitr::include_graphics("hf_complete_plot.png")

```

\newpage

## Timeliness {.unnumbered}

**Time to notification** is measured by the number of days from the time of diagnosis of the NMC to the time of notification. Overall, it took a median (IQR) of `r cat1_notif_time` days to report category 1 NMCs. 

```{r  , warnings = FALSE, message=FALSE, fig.cap = paste0("The mean and median number of days from time of diagnosis to notification date of NMC clinically notified conditions, in South Africa, January, 2022-", reporting_date_month, ". The hospital form was implemented in the beginnign of 2023 but has been hindered by budget constraints") }

# look at timeliness of clincal notifications over the last few years 

# there are a few ways to look at timeliness 

# time from diagnosis date to notification date 
# time form symptom date to notification date

df%>%select( contains( "date"))%>%names-> date_vars

# look at which dates are missing based on the caste_type 

new_master %>%
  filter( year > 2022, 
 ! condition %in% "Covid-19")%>%
  select(case_type, 
         notification_date, 
         symptom_date, 
         diagnosis_date)%>%
         mutate( 
          across(
            c(notification_date, symptom_date, diagnosis_date), 
            ~ is.na(.))
         )%>%
  tbl_summary(
    by = case_type,
    label = list(notification_date ~ "Notification Date", 
                 symptom_date ~ "Symptom Date", 
                 diagnosis_date ~ "Diagnosis Date")
  )-> 
  
  tbl_missing_dates



# how may clinical notificaitons are there per category?

new_master %>% 
  filter( 
    #case_type %in% "Clinical notifications",
    facility_sector %in% c("Public", "Private")
  ) %>%
  select(
    case_type,
    nmccategories
  ) %>%
  tbl_summary(
    by = nmccategories,
  ) %>%
  add_p()-> 

  tbl_case_source


# we can also have the "landed date" in the NMC system 
new_master %>%
  filter( condition != "Covid-19",
  year %in% 2022: (as.numeric( as_year( Sys.Date() ))))%>%
  mutate( 
    year = as.numeric( as.character( year)),
    Month_notification = as.Date(notification_date) %>% floor_date("month"),
    landed_date =as.character(str_extract(case_id, "^\\d{6}") %>% as_date()), 
    time_to_notification = difftime(notification_date, diagnosis_date, units = "days"),
    symptom_to_notification = difftime(notification_date, symptom_date, units = "days"),
    notification_to_landed = difftime(landed_date, notification_date, units = "days"), 
  )%>%
  filter( 
    #grepl( "merged", case_type, ignore.case = TRUE)
    )%>%
  select( 
    case_type , 
    nmccategories,
    landed_date, 
    symptom_to_notification, 
    time_to_notification, 
    notification_to_landed, 
    Month_notification
  )%>%
  filter( 
    time_to_notification %in% 0:100
  )%>%
  group_by( 
    case_type,
    nmccategories, 
    Month_notification
  )%>%
  summarise(
    landed_date = mean(landed_date, na.rm = T)%>%as.numeric(),
    mean_symptom_to_notification = mean(symptom_to_notification, na.rm = T)%>%as.numeric(),
    median_symptom_to_notification = median(symptom_to_notification, na.rm = T)%>%as.numeric(),
    mean_time_to_notification = mean(time_to_notification, na.rm = T)%>%as.numeric(),
    median_time_to_notification = median(time_to_notification, na.rm = T)%>%as.numeric(),
    mean_notification_to_landed = mean(notification_to_landed, na.rm = T)%>%as.numeric(),
    median_notification_to_landed = mean(notification_to_landed, na.rm = T)%>%as.numeric()
  )%>%
    mutate( 
    threshold = 
    case_when( 
      nmccategories == 1 ~ 1,
      nmccategories == 2 ~ 7,
      nmccategories == 3 ~ 28,
    ), 
    ) %>%
    filter(
    Month_notification > as.Date("2022-01-01"),
    ) %>%
  ungroup() ->
  df_time




df_time%>%
  filter( 
    
  )%>%
  ggplot(
  ) + 
      geom_line( 
    aes(
      x = Month_notification,
      y = threshold,
      linetype = "solid", 
    )
  )+ 
  facet_nested( 
    rows = vars(nmccategories), 
    cols = vars(case_type),
  )+
  geom_line(
        aes(
          x = Month_notification,
          y = mean_time_to_notification,
          color = nmccategories,
          group = nmccategories,
          linetype = "dashed"
        )
  ) +
  geom_line(
    aes(
      x = Month_notification,
      y = median_time_to_notification,
      color = nmccategories, 
      group = nmccategories, 
      linetype = "dotted"
    ),
  ) + 
      scale_linetype_discrete(
      name = "Statistic",
      labels = c("Mean", "Median", "Timeliness threshold")
      )+
  scale_x_date( 
    date_labels = "%Y", 
    date_breaks = "1 year", 
    expand = expansion(mult = c(0.01, 0.1))
  )+
  scale_y_continuous(
      limits = c(0, 15),
    breaks = c(0, 1,7, 10, 15 ),
    labels =c(0, 1,7, 10, 15 )
  )-> 
  plot_time_to_notification

  


df_time %>%
  filter( 
    !grepl( "lab", case_type, ignore.case = TRUE)  
  )%>%
  filter(
    Month_notification > as.Date("2022-01-01"),
  ) %>%
  ggplot() +
    geom_line(
    aes(
      x = Month_notification,
      y = threshold,
    linetype = "solid",
    ),

  ) +
    facet_nested(
      rows = vars(nmccategories),
      cols = vars(case_type),
    )+
  geom_line(
    aes(
      x = Month_notification,
      y = mean_symptom_to_notification,
      color = nmccategories,
      group = nmccategories,
            linetype = "dashed"
    )
  ) +
  geom_line(
    aes(
      x = Month_notification,
      y = median_symptom_to_notification,
      color = nmccategories,
      group = nmccategories,
      linetype = "dotted"
    ),

  ) +
    scale_linetype_discrete(
      name = "Statistic",
      labels <- c("Mean", "Median", "Timeliness threshold")
    )+
  scale_x_date(
    date_labels = "%Y",
    date_breaks = "1 year",
    expand = expansion(mult = c(0.01, 0.1))
  ) +
  scale_y_continuous(
    limits = c(0, 30),
    breaks = c(0, 1,7, 10, 15, 30 ),
    labels =c(0, 1,7, 10, 15, 30 ),
  )-> plot_symptom_to_notification




# ==================================================
#Time to notification is the dianosis date to notification date
# ==================================================
  plot_time_to_notification+
    as_excel() +
    theme(
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      panel.grid.major.y = element_line(size = 0.15, color = "grey20"),
      panel.grid.minor.y = element_blank(),
      axis.ticks = element_line(size = 0.15, color = "grey20"),
      strip.text.y.right = element_text(angle = 0, size = 10, hjust = 0, face = "bold"),
    ) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      strip.text.y.right = element_text(angle = 0, size = 15, hjust = 0),
      legend.position = "bottom"
    ) +
  guides( 
    color = guide_legend(
      nrow = 1
    ), 
    linetype = guide_legend(
      nrow = 1
    )
  ) + 
    labs(
      title = "Time to Notification (diagnosis to notification)", 
      x = "Notification Month", 
      color = "NMC Category"
    )-> plot_time_to_notification


# ==================================================
# Symptom to notification is the symptom date to notification date
# ==================================================
plot_symptom_to_notification+
  as_excel()+
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(size = 0.15, color = "grey20"),
    panel.grid.minor.y = element_blank(),
    axis.ticks = element_line(size = 0.15, color = "grey20"), 
    strip.text.y.right = element_text(angle = 0, size = 10, hjust = 0, face = "bold"),
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text.y.right = element_text(angle = 0, size = 15, hjust = 0),
    legend.position = "bottom") +
    guides( 
    color = guide_legend(
      nrow = 1
    ), 
    linetype = guide_legend(
      nrow = 1
    )
  ) + 
    labs(
      title = "Time from symptom to notification",
      x = "Notification Month",
      color = "NMC Category"
    )-> plot_symptom_to_notification


#plot_symptom_to_notification
#plot_time_to_notification

gg2word_cond(plot_time_to_notification, "plots")

```


```{r}
#| label: fig-time-to-notification-stacked
#| fig-cap: !expr 'paste0("The timeliness of category of weekly number of confirmed notifications for selected category 1 conditions reported to the NMC, in South Africa; January 2022-",  reporting_date_month_year)'


df %>%
  filter(nmccategories == 1) %>%
  select(condition, time_to_notification) %>%
  mutate(
    time_to_notification = as.numeric(time_to_notification),
    categories_time_to_notification =
      factor(
        case_when(
          time_to_notification < 1 ~ "0 days",
          time_to_notification >= 1 & time_to_notification < 2 ~ "1 day",
          time_to_notification >= 2 & time_to_notification < 3 ~ "2 days",
          time_to_notification >= 3 & time_to_notification < 4 ~ "3 days",
          time_to_notification >= 4 & time_to_notification < 5 ~ "4 days",
          time_to_notification >= 5 & time_to_notification < 6 ~ "5 days",
          time_to_notification >= 6 & time_to_notification < 7 ~ "6 days",
          time_to_notification >= 7 & time_to_notification < 8 ~ "7 days",
          TRUE ~ "8+ days"
        ),
        levels = c(
          "8+ days", "7 days", "6 days", "5 days", "4 days", "3 days", "2 days", "1 day", "0 days"
        )
      )
  ) %>%
  group_by(
    condition,
    categories_time_to_notification
  ) %>%
  reframe(
    n = n()
  ) %>%
  ggplot() +
  geom_col(
    aes(
      x = condition,
      fill = categories_time_to_notification,
      y = n
    ),
    position = "fill"
  ) +
  scale_fill_manual(
    values = c(
      "0 days" = "#4CAF50", # green
      "1 day" = "#8BC34A", # lighter green
      "2 days" = "#d9ef8b", # light yellow-green
      "3 days" = "#fee08b", # yellow
      "4 days" = "#fed976", # yellow-orange
      "5 days" = "#fdae61", # orange
      "6 days" = "#f46d43", # light red-orange
      "7 days" = "#d73027", # red
      "8+ days" = "#a50026" # dark red
    ), 
    expand = expansion(mult = c(0.01, 0.01))
    
  ) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1),
    expand = expansion(mult = c(0, 0.1)), 
    breaks = seq(0, 1, by = 0.1)
  ) +
  geom_hline( 
    yintercept = 0.8, 
    linetype = "dashed", 
    color = "darkred"
  )+ 
  # insert label for the hline that is that target for time to notification
  geom_label(
    aes(
      x = 2,
      y = 0.82,
      label = "Target: \n within <1 day"
    ),
    color = "darkred",
    size = 3.5,
    hjust = 0
  ) +

  labs(
    x = "Category 1 NMC conditions",
    y = "Proportion of notifications",
    fill = "Time to Notification"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )-> 
  timeliness_cat1_plot


gg2word_cond(timeliness_cat1_plot, "plots")




```

```{r}

 tbl_notifications<- df%>%select(nmccategories, time_to_notification, back_capture_new) %>%
  mutate(time_to_notification = as.numeric(time_to_notification))%>%
  tbl_summary(by= nmccategories, 
            label = list(time_to_notification ~ "Time to Notification",
                         back_capture_new ~ "Back Capture Classification"),
            digits = list(everything() ~ c(0,0))
            )%>%
  modify_footnote(
    #update = everything() ~ NA
    )%>%
  modify_header( all_stat_cols() ~ "**Category {level}**, \n n = {scales::number(n)}")

cat1_notif_time<- tbl_notifications[["table_body"]][["stat_1"]][[1]]%>%as.character()

tbl_notifications%>%as_flex_table()%>%
  flextable::set_caption(paste0("Symptoms of patients clinically notified and merged with lab notifications to the NMC, notified during ", reporting_date_month_year)) %>%# Example: making the first row (header) bold
    fontsize(, size = 9, part = "header")%>%
  flextable::set_table_properties(layout = "autofit", width = 0.99)

```

\newpage

# Conclusion {.unnumbered}

The majority of notifications were clinical notifications. Patients who are hospitalized with a category 1 condition and notified still have poor completeness of the hospital form with the majority of notifications only having symptom completed. ID numbers are poorly completed in notifications from SDW. 

# Recommendations  {.unnumbered}
```{r}
email <- "brianb@nicd.ac.za"

# Create a clickable hyperlink
email_address <- paste0("[here](", email, ")")
```

-   We recommend that clinicians should complete all patient clinical and demographic details to improve hospital form completeness.
-   We strongly recommend complete ID number capture in the SDW system to improve data quality and the ability for the NMCSS to merge clinical and laboratory notifications. 
- 	We welcome stakeholders to send feedback and suggestions for the report. We also encourage reaching out for ingestion of data from data from data sources that existed prior to the launch of the NMCSS. Feel free to reach out to **brianb@nicd.ac.za** and **matimbam@nicd.ac.za**.

\newpage

# Appendices  {.unnumbered}

## Appendix no.1: Back captured clinical notifications {.unnumbered}

```{r , echo=FALSE}

back_cap_by_case_Source<- df2%>%dplyr::select(case_source, condition)%>%
  mutate(case_source = ifelse(case_source == "Microstrategy/SDW", "SDW", case_source))%>%
tbl_summary(., 
            by = case_source, 
            label = condition ~"", 
            statistic = everything() ~ "{n}", 
            sort = list(everything() ~ "frequency")
            )%>%
  modify_header(label = "",
                all_stat_cols() ~ "**{level}**, \n ({scales::number(n)})")%>%
  #modify_footnote( update =  everything() ~ NA)
  modify_footnote(all_stat_cols() ~ "SDW – Surveillance data warehouse/ Microstrategy") 



merged_back_captured <- tbl_merge(tbls = list(back_captured_overall, back_captured, back_cap_by_case_Source), 
          tab_spanner = c("**Overall**", "**Province**", "**Case Source**"))%>%trim_tbl




merged_back_captured%>%
    as_flex_table()%>%
  flextable::set_caption(paste0("Back captured notifications by reporting province notified during ", reporting_date_month," \\\n *Back captured notifications use the diagnosis date, and the recommended time to notification depending on the NMC category. See Appendix no.3 for details")) %>%# Example: making the first row (header) bold
    fontsize(, size = 9, part = "header")%>%
  flextable::set_table_properties(layout = "autofit",
                                  width = 0.99)%>%
  width(., j = 2, width = 1.5, unit = "cm")


#min_date<- min(as_date(df$diagnosis_date), na.rm = T)
#format(as.Date(min_date), "%e %B, %Y")

#### Inlude the delayed cases with current cases !!! ########## and also include by province.

```



```{r, include = FALSE}


#xtabs(~ condition+ source_2, data = df2)

back_cap_by_case_Source<- df2%>%dplyr::select(case_source, condition)%>%
tbl_summary(., 
            by = case_source, 
            label = condition ~"", 
            statistic = everything() ~ "{n}"
            )%>%
  modify_header(label = "") %>%
  modify_footnote( update =  everything() ~ NA)

back_cap_by_case_Source_tot<- df2%>%dplyr::select( condition)%>%
tbl_summary(., 
            #by = case_source, 
            label = condition ~"", 
            #statistic = everything() ~ "{n}"
            )%>%
  modify_header(label = "") %>%
  modify_footnote( update =  everything() ~ NA)%>%
  modify_footnote()



tbl_merge( tbls = list( back_cap_by_case_Source_tot , back_cap_by_case_Source), 
           tab_spanner = c("**Overall**", "**Case Source**")) %>%
  trim_tbl() %>%
  as_flex_table()%>%
  flextable::set_caption("Back captured notifications by reporting case source") %>%# Example: making the first row (header) bold
    fontsize(, size = 8, part = "header")%>%
  flextable::set_table_properties(layout = "autofit", width = 0.99)

```

\newpage

## Appendix no.2: Summary of NMCSS Data Flow {.unnumbered}

```{r fig_flow, out.width='100%', fig.cap='', out.width = "100%"}
knitr::include_graphics("images/dataflow.png")
```

\newpage

## Appendix no.3: NMC Categories, and Case Classification definitions {.unnumbered}

::: {.alert .alert-info}
<strong></strong>**NMC categories**

**Category 1**: NMCs notified by the most rapid means available upon diagnosis, followed by a written or electronic notification to the Department of Health within 24 hours of diagnosis by healthcare providers, private health laboratories or public health laboratories. These conditions must be notified based on clinical suspicion irrespective of laboratory confirmation.

**Category 2**: NMCs notified through a written or an electronic notification to the Department of Health of clinical or laboratory diagnosis within 7 days by healthcare providers, private health laboratories or public health laboratories.

**Category 3**: NMCs notified through a written or electronic notification to the Department of Health within 7 days of diagnosis by public and private health laboratories.

**Category 4**: NMCs notified through a written or electronic notification to the Department of Health within 1 month of diagnosis by public and private health laboratories.

**Case Classification definitions**

**Clinical case**: are cases reported to the NMC by health care providers at facilities, either through completion of a paper form that is faxed, emailed to National Institute of Communicable Diseases (NICD), or by direct data entry into the NMC application on a PC, laptop or mobile device. The diagnosis is made by the clinician on the basis of case definitions published on the NICD website.

**Laboratory case**: are cases that are downloaded into the NMC database directly from the National Health Laboratory Services (NHLS) laboratory information system. The NMC application applies the case definitions that are published on the NICD website. Private sector data is being sourced.

**Merged cases**: are cases where a case was notified by health care provider at the facility (a 'clinical case') AND the laboratory issued a report with a positive result for the same case (a 'laboratory case). The NMC App is set up to automatically detect and link clinical and laboratory case notifications. The NICD specialist Centres and NMC data team review all cases and manually link any remaining clinical and laboratory cases

**Notification capture times definitions**

**Current notification**: Category 1 conditions notified within 2 days of diagnosis date. Category 2 and 3 conditions notified within 7 days of diagnosis. All lab notifications without diagnosis date are classified as current. 

**Delayed notification**: Category 1 conditions notified within between 3 and 7 days of diagnosis date. Category 2 and 3 conditions notified between 8 and 30 days of diagnosis.

**Back capture notification**: Category 1 conditions notified more than 7 days of diagnosis date. Catgeory 2 and 3 conditions notified more than 30 days of diagnosis date.

**Epiweeks**: Epiweeks used the CDC definition of a week starting on a Sunday and ending on a Saturday. The first epiweek of the year is the week that contains the first Saturday of January. Epiweek 1 of 2024 started on 31 December 2023 and ended on 6 January 2024.
:::

\newpage

## Appendix no.4: IDSR reporting template for IDSR conditions existing on NMC by under-5 and 5-and-over years and vital status. {.unnumbered}

```{r tbl-IDSR,  warnings = FALSE, message=FALSE, include = TRUE}


all_IDSR_conditions = tibble( condition = c(
  "Acute Flaccid Paralysis", "Acute rheumatic fever", "Anthrax", "Botulism", "Cholera",
  "Congenital rubella syndrome", "Diphtheria", "Enteric fever (typhoid or paratyphoid fever)",
  "Food-borne disease", "Hemolytic uraemic syndrome (HUS)", "Listeriosis", "Malaria", "Measles",
  "Meningococcal disease", "Monkeypox (Mpox)", "Pertussis", "Plague", "Poliomyelitis",
  "Rabies (human)", "Respiratory disease caused by novel respiratory pathogen",
  "Rift valley fever (human)", "Rubella", "Smallpox", "Viral haemorrhagic fever diseases",
  "Yellow Fever", "COVID-19", "SARS", "Agricultural or stock remedy poisoning",
  "Bilharzia (schistosomiasis)", "Brucellosis", "Congenital syphilis",
  "Hemophilus influenzae type B", "Hepatitis A", "Hepatitis B", "Hepatitis C",
  "Hepatitis E", "Lead poisoning", "Legionellosis", "Leprosy",
  "Maternal death (pregnancy, childbirth and peuperium)", "Mercury poisoning", "STH***",
  "Tetanus", "Tuberculosis: pulmonary", "Tuberculosis: extra-pulmonary",
  "Tuberculosis: multidrug-resistant (MDR-TB)", "Gonorrhoea", "Endemic arboviral* diseases",
  "Non-endemic arboviral** diseases", "Non-thyphoidal Salmonellosis", "Shiga toxin-producing E coli",
  "Shigellosis (Shigella spp.)", "Bacterial meningitis", "Middle East respiratory syndrome (MERS)",
  "Severe Acute Respiratory Infection (SARI)", "Influenza Like Illness (ILI)", "Mumps",
  "Lymphatic filariasis", "Adverse events following immunization (AEFIs)",
  "Diabetes Mellitus (new cases)", "Diarrhoea with dehydration less than 5 years of age",
  "Epilepsy", "HIV/AIDS (new cases)", "Hypertension (new cases)", "Injuries (road traffic accidents)",
  "Malnutrition in children under 5 years of age", "Non-neonatal tetanus", "Perinatal deaths",
  "Severe pneumonia less than 5 years of age", "STIs#", "Scabies", "Snake bites", "Animal bites",
  "Events of Public Health Importance", "Healthcare associated Infections or multi drug resistant organisms",
  "Others (specify)"
))



IDSR_NMC_cat1<- df1%>%dplyr::select(condition, nmccategories) %>%unique%>%left_join(.,all_IDSR_conditions, by = "condition" )%>%filter(nmccategories == 1)%>%dplyr::select(condition) %>%pull()


IDSR_notifications<- df1 %>% filter(case_definition == "Suspected", nmccategories == 1)%>%
  mutate( condition = factor(condition, levels = c(category_1, setdiff(cat_1, category_1))),
          five_year = ifelse(age < 5  , "Under 5", "5 & over"),
          death = ifelse( patient_vital_status== "Deceased", "D", "A"))%>%
  mutate(idsr_cat = factor(paste0(five_year," ", death),                      
                           levels = c( 
                                     "Under 5 A", 
                                     "5 & over A",
                                     "5 & over D",
                                     "Under 5 D"
                           )))%>%
  #filter(nmccategories == 1) %>%
  select(condition, #five_year, 
         idsr_cat)%>%
  #tbl_strata(., strata = death, 
  #           .tbl_fun =
  #             ~ .x %>%
               tbl_summary(by = idsr_cat,
                           statistic = list(everything() ~ "{n}")#)
  )  %>%modify_header(label = "Condition",

                all_stat_cols() ~ "**{level}**, \n N = {scales::number(n)}")%>%
  modify_footnote( update =  everything() ~ NA)



IDSR_confirmed<- df1 %>% filter(nmccategories==1, case_definition %in% "Confirmed")%>%
  mutate( condition = factor(condition, levels = c(category_1, setdiff(cat_1, category_1))),
          five_year = ifelse(age < 5  , "Under 5", "5 & over"),
          death = ifelse( patient_vital_status== "Deceased", "D", "A"))%>%
  #filter(nmccategories == 1) %>%
  select(condition)%>%
               tbl_summary(#by = death,
                           statistic = list(everything() ~ "{n}")) %>%
  modify_header(label = "Condition") %>%
  modify_footnote( update =  everything() ~ NA)


merged_IDSR<- tbl_merge(tbls = list(IDSR_notifications, IDSR_confirmed), 
          tab_spanner = c("Notified/Suspected", "Confirmed")
          )%>%
  modify_footnote(all_stat_cols() ~ "A = Cases who are alive. \n D = Cases who are deceased."  )

length<- merged_IDSR[["table_body"]]%>%nrow()
merged_IDSR[["table_body"]]<- merged_IDSR[["table_body"]][2:length,]


merged_IDSR%>%as_flex_table      %>%
  flextable::set_caption("The number of IDSR conditions laboratory notified to the NMC using the IDSR reporting template of under and 5-and-above years by vital status.") %>%# Example: making the first row (header) bold
    fontsize(, size = 9, part = "header")%>%
  flextable::set_table_properties(layout = "autofit", width = 0.99)

# We are missing the age strata. What we could do is
```
\newpage

```{r, include= FALSE, evaluate = FALSE}

IDSR_notifications_cat<- df1 %>% filter(nmccategories==1)%>%
  mutate( condition = factor(condition, levels = c(category_1)),
          five_year = ifelse(age %in% c(0:4)   , "Under 5", "5 & over"),
          death = ifelse( patient_vital_status== "Deceased", "D", "A"))%>%
  
  mutate(idsr_cat = paste0(five_year," ",death))%>%select(idsr_cat)%>%unique()%>%pull()
  
#IDSR_notifications_cat
#df1$patient_vital_status%>%unique

IDSR_notifications_V2<- df1 %>% filter(nmccategories==1)%>%
  mutate( condition = factor(condition, levels = c(category_1)),
          five_year = ifelse(age %in% c(0:4)  , "Under 5", "5 & over"),
          death = ifelse( patient_vital_status== "Deceased", "D","A")
                         )%>%
  mutate(idsr_cat = factor(paste0(five_year," ", death),                      
                           levels = c( 
                                     "Under 5 A", 
                                     "Under 5 D",  
                                     "5 & over A",
                                     "5 & over D"
                           )))%>%
  #filter(nmccategories == 1) %>%
  select(condition, idsr_cat)%>%
  tbl_summary(., 
              by = idsr_cat, 
              statistic = list(everything() ~ "{n}"))%>%
  modify_header(all_stat_cols() ~ "**{level}**")


IDSR_confirmed_V2<- df1 %>% filter(nmccategories==1, case_definition %in% "Confirmed")%>%
  mutate( condition = factor(condition, levels = c(category_1)),
          five_year = ifelse(age >5  , "Under 5", "5 & over"),
          death = ifelse( patient_vital_status== "Deceased", "D", "A"))%>%
  mutate(idsr_cat = factor(paste0(five_year," ", death),                      
                           levels = c( 
                                     "Under 5 A", 
                                     "Under 5 D",  
                                     "5 & over A",
                                     "5 & over D"
                           )))%>%
  #filter(nmccategories == 1) %>%
  select(condition, idsr_cat)%>%
  tbl_summary(., 
              by = idsr_cat,
              statistic = list(everything() ~ "{n}")) %>%
  modify_header(all_stat_cols() ~ "**{level}**")

mergedIDSR<-tbl_merge(tbls = list(IDSR_notifications_V2, IDSR_confirmed_V2),
          tab_spanner = c( "Suspected", "Confirmed"))%>%as_flex_table%>%autofit


length<- mergedIDSR[["body"]][["dataset"]]%>%nrow()
mergedIDSR[["table_body"]]<-mergedIDSR[["body"]][["dataset"]][2:length,]

mergedIDSR

```
\newpage

## Appendix no.5: Trends and epitable of all Category 1 notifications 2022 to `r reporting_date_month_year`. {.unnumbered}

### All Notifications {.unnumbered}

#### Epitable {.unnumbered}

```{r}

conflicts_prefer(dplyr::filter)

flextable::set_flextable_defaults(
  font.family = "Century Gothic", 
  font.size = 6, 
  header.font.size = 6,
  border.color = "black", 
  padding = 0.1)


source("scripts_and_functions/context_table.R")
#load("outputs/context_table.rda")
#context_table %>%autofit()

make_fever_rash <- function( data, fever_rash_label = "Fever-Rash"){
data %>%
  mutate( condition = if_else( condition%in% c("Measles", "Rubella"), "Fever-Rash", condition)) -> df 
  return(df)
}


context_table(new_master1%>%make_fever_rash, as_date(last_dat_reporting_month))-> ft
# used to be ``` grey_column <-  ft[[2]].....
grey_column <- max_full_epiweek - df1$notification_date %>%
  as_date() %>%
  max() %>%
  as_epiweek() %>%
  gsub(".*W", "", .) %>%
  as.numeric() + 4

ft[[1]]$col_keys %>% length() ->
col_length

ft[[1]] %>%
  autofit() %>%
  flextable::set_caption(
    "Number of notifications on NMCSS per epiweek in", current_year, " . The Average notifications are calculated based on notifications received in 2022 and 2023 with a confidence interval."
  ) %>%
  fontsize(size = 7, part = "all") %>%
  bg(,
    j = (col_length - 4):col_length, # this will gry out the last 4 columns
    bg = "grey90",
    part = "body"
  )


```


#### Trends Plot  Category 1 {.unnumbered}

```{r, echo = FALSE, include = FALSE}



df_epicurve_all<- 
  new_master1%>%
  make_fever_rash()%>%
  dplyr::filter( notification_date > lubridate::as_date( "2022-01-20"))%>%
  ungroup() %>%
  dplyr::filter( nmccategories ==1) %>%
  make_fever_rash()%>%
  #dplyr::filter( condition =="COVID-19") %>%
  
  #dplyr::filter( notification_date < as_date("  as.numeric(as_year(Sys.Date() )) -01-01") )%>%
  epicurve_df(., 
              date_index = "notification_date", 
              grouping_vars = "condition")


df_epicurve_all1<-df_epicurve_all%>%dplyr::filter( year%in%2022:  as.numeric(as_year(Sys.Date() )) )%>%
  mutate( year = factor(year, levels = c(2022:  as.numeric(as_year(Sys.Date() )) )))

df_epicurve_all1$condition%>%unique

plot<- df_epicurve_all1%>%
  dplyr::filter( condition %in% c("Cholera", 
                           "Covid-19", 
                           "Diphtheria", 
                           "Fever-Rash",
                           "Malaria", 
                           "Meningococcal disease"   ,
                           "Congenital rubella syndrome" ,
                           "Diphtheria",
                          # "Measles", 
                          #"Rubella"
                           "Mpox",                  
                           "Pertussis",
                           "Listeriosis"
                           ))%>%
                           
  plot_epicurve_df(., 
                                   x_axis_option = "epiweek", 
                                   grouping_vars = "condition",
                                    color_select = "olivedrab"
                   )
#plot$plot

```



```{r, fig.cap = paste0("Trend of weekly number of all notifications for selected conditions reported to the NMC, in South Africa, January, 2022-", reporting_date_month) }
source("scripts_and_functions/gg2word.R")
gg2word(plot$plot, "outputs", dims = c(11,6.5))

```

```{r}
conflicts_prefer(dplyr::filter)
```

\newpage




#### Trends Plot  Category 2 {.unnumbered}


```{r, echo = FALSE, include = FALSE}



df_epicurve_all<- 
  new_master1%>%
  make_fever_rash()%>%
  dplyr::filter( notification_date > lubridate::as_date( "2022-01-20"))%>%
  ungroup() %>%
  dplyr::filter( nmccategories ==2) %>%
  make_fever_rash()%>%
  #dplyr::filter( condition =="COVID-19") %>%
  
  #dplyr::filter( notification_date < as_date("  as.numeric(as_year(Sys.Date() )) -01-01") )%>%
  epicurve_df(., 
              date_index = "notification_date", 
              grouping_vars = "condition")


df_epicurve_all1<-df_epicurve_all%>%dplyr::filter( year%in%2022:  as.numeric(as_year(Sys.Date() )) )%>%
  mutate( year = factor(year, levels = c(2022:  as.numeric(as_year(Sys.Date() )) )))

df_epicurve_all1$condition%>%unique

plot<- df_epicurve_all1%>%
  dplyr::filter( condition %in% c(
"Agricultural or stock remedy poisoning"      ,
 "Bilharzia (schistosomiasis)"  ,
  "Hepatitis A"     , 
  "Hepatitis B"     , 
  "Hepatitis C"     , 
  "Hepatitis E"   ) |
  grepl( "tuber", ignore.case = TRUE, condition ))%>%
                           
  plot_epicurve_df(., 
                                   x_axis_option = "epiweek", 
                                   grouping_vars = "condition",
                                    color_select = "olivedrab"
                   )

plot$plot + 
  scale_fill_manual( values = "darkred")-> plot_cat2

```



```{r, fig.cap = paste0("Trend of weekly number of all notifications for selected conditions reported to the NMC, in South Africa, January, 2022-", reporting_date_month) }
source("scripts_and_functions/gg2word.R")
gg2word(plot_cat2, "outputs", dims = c(11,6.5))

```

```{r}
conflicts_prefer(dplyr::filter)
```

\newpage

```{r}
# install.packages(c("tibble", "flextable"))  # if not already installed
library(tibble)
library(flextable)

# 1. Create the tibble
df_contacts <- tribble(
    ~Province, ~`Name and Surname`, ~`Email address`, ~`Cell Numbers`,
    "Eastern Cape", "Nkosimpendulo Mngceke", "nkosimpendulom@nicd.ac.za", "082 888 6194 / 083 519 5969",
    "Free State", "Moeketse Pheko", "moeketsep@nicd.ac.za", "060 978 3042 / 076 889 7319",
    "Gauteng & Northwest", "Bokelani Nyaose", "bukelanin@nicd.ac.za", "071 670 8741",
    "Gauteng & Northwest", "Lorato Mthombeni", "loratom@nicd.ac.za", "072 134 1818",
    "KwaZulu-Natal", "Shakira Naido", "shakiran@nicd.ac.za", "071 303 7392",
    "Limpopo", "Vuyolwethu Mashamaite", "vuyolwethum@nicd.ac.za", "060 963 4834",
    "Mpumalanga", "Lesley Ingle", "lesleyI@nicd.ac.za", "066 308 7539",
    "Northern Cape", "Matsheko Thekiso", "matshekot@nicd.ac.za", "060 984 0980",
    "Western Cape", "Washiefa Isaacs", "washiefaI@nicd.ac.za", "064 742 4005"
)

# 2. Build and style the flextable
flextable(df_contacts) %>%
    set_header_labels(
        Province = "Province",
        `Name and Surname` = "Name and Surname",
        `Email address` = "Email Address",
        `Cell Numbers` = "Cell Numbers"
    ) %>%
    theme_booktabs() %>% # clean, minimal styling
    autofit() %>% # adjust column widths
    set_table_properties(width = 0.9, layout = "autofit") %>% # set table width
    theme_zebra() %>% # zebra striping
    bg(
        part = "header",
        i = 1, # apply background color to the first column (Province)
        bg = "#A5CA64"
    ) %>%
    flextable::color(, color = "white", part = "header") -> ft_contacts
# 3. Print
ft_contacts


```

__END__