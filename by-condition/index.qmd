---
title: "By Condition"
subtitle: "National trends, provincial comparisons & district hotspots per condition"
format:
  html:
    page-layout: full
    toc: true
    toc-depth: 2
---

::: {.callout-note collapse="true"}
## Development Roadmap â€” By Condition

| Phase | Feature | Status |
|-------|---------|--------|
| **v0.1** | Weekly national epicurve stacked by province (interactive) | âœ… Done |
| **v0.1** | Provincial incidence trend lines | âœ… Done |
| **v0.1** | District hotspot table (last 30 days) with export | âœ… Done |
| **v0.2** | Condition-specific summary cards (key metrics) | ðŸ”² Planned |
| **v0.2** | Animated epi-curve (gganimate / plotly animation) | ðŸ”² Planned |
| **v0.3** | Leaflet hotspot map â€” district-level choropleth | ðŸ”² Planned |
| **v0.3** | Province comparison heatmap (condition Ã— province) | ðŸ”² Planned |
| **v0.4** | Age/sex breakdown where demographic data available | ðŸ”² Planned |
| **v0.5** | EpiNow2 Rt ribbon per condition fed from `agg_national.rds` | ðŸ”² Planned |

*Data pipeline:* `R/prepare_dashboard_data.r` â†’ `data/processed/agg_province.rds`, `agg_district.rds`
:::

```{r}
#| label: setup
#| include: false
#| message: false
#| warning: false

suppressPackageStartupMessages({
  library(data.table)
  library(plotly)
  library(crosstalk)
  library(DT)
  library(lubridate)
  library(htmltools)
})

# â”€â”€ Load processed data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
agg_prov <- readRDS("data/processed/agg_province.rds")
agg_dist <- readRDS("data/processed/agg_district.rds")
setDT(agg_prov); setDT(agg_dist)

agg_prov <- agg_prov[!is.na(prov_) & prov_ != ""]
agg_dist <- agg_dist[!is.na(district) & district != ""]

agg_prov[, date := as.Date(date)]
agg_dist[, date := as.Date(date)]

# â”€â”€ Weekly aggregation for epicurves â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
agg_prov[, week_start := floor_date(date, "week")]

weekly <- agg_prov[, .(
  cases          = sum(count),
  incidence_100k = round(mean(incidence_100k, na.rm = TRUE), 3)
), by = .(Week = week_start, Condition = condition, Province = prov_)]

sd_weekly <- SharedData$new(weekly)

# â”€â”€ District hotspots (last 30 days) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
hotspots <- agg_dist[date >= (Sys.Date() - 30), .(
  Cases = sum(count)
), by = .(Condition = condition, Province = prov_, District = district)]
setorder(hotspots, -Cases)
sd_hotspot <- SharedData$new(hotspots)
```

## Filter

```{r}
#| label: condition-filter
div(
  style = "display:flex; gap:2rem; flex-wrap:wrap; margin-bottom:1.5rem;",
  div(style = "min-width:260px;", filter_select("cond", "Select Condition", sd_weekly, ~Condition)),
  div(style = "min-width:180px;", filter_select("prov", "Province (optional)", sd_weekly, ~Province))
)
```

---

## Epidemic Curves {.tabset}

### Weekly Cases by Province

```{r}
#| label: fig-epicurve
#| fig-cap: "Weekly case counts stacked by province â€” use the filter above to select a condition"
plot_ly(sd_weekly, x = ~Week, y = ~cases, color = ~Province,
        type = "bar",
        hoverinfo = "text",
        text = ~paste0(Province, " â€” wk ", format(Week, "%d %b %Y"),
                       "<br>Cases: ", cases)) %>%
  layout(barmode = "stack",
         xaxis = list(title = "Week starting"),
         yaxis = list(title = "Weekly cases"),
         legend = list(orientation = "h", y = -0.15))
```

### Provincial Incidence Trends

```{r}
#| label: fig-incidence-trend
#| fig-cap: "Weekly incidence per 100 000 by province"
plot_ly(sd_weekly, x = ~Week, y = ~incidence_100k, color = ~Province,
        type = "scatter", mode = "lines",
        hoverinfo = "text",
        text = ~paste0(Province, " â€” ", format(Week, "%d %b %Y"),
                       "<br>Inc: ", incidence_100k, " /100k")) %>%
  layout(xaxis = list(title = "Week starting"),
         yaxis = list(title = "Incidence per 100 000"),
         legend = list(orientation = "h", y = -0.15))
```

---

## District Hotspots â€” Last 30 Days

```{r}
#| label: hotspot-filter
div(
  style = "margin-bottom:1rem;",
  filter_select("hcond", "Condition", sd_hotspot, ~Condition)
)
```

```{r}
#| label: tbl-hotspots
DT::datatable(
  sd_hotspot,
  extensions = "Buttons",
  filter   = "top",
  rownames = FALSE,
  options  = list(
    dom        = "Bfrtip",
    buttons    = c("csv", "excel"),
    pageLength = 20,
    order      = list(list(2, "desc")),
    scrollX    = TRUE
  )
)
```

---

::: {.callout-tip}
## Related Sections
- [By Province](../by-province/index.html) â€” province-first view with district drilldown
- [Trending & Signals](../by-trending/index.html) â€” signal detection for emerging conditions
- [Burden of Disease](../burden-of-disease/index.html) â€” YLL, DALYs & age-standardised rates
- [Forecasts](../by-forecasts/index.html) â€” short-term predictive models
- [Explorer](../explorer/index.html) â€” custom data queries and downloads
- [Methods](../methods.html) â€” indicator definitions and data sources
:::
